<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ screen_name }} - Aktivitetsplan</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            padding: 0;
            overflow: hidden;
        }

        body {
            display: flex;
            flex-direction: column;
        }

        /* Header - samme for alle templates */
        .header {
            background: #EF7D00;  /* MAGION Orange - PANTONE 151 C */
            padding: 20px 40px;
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: fadeIn 0.8s;
            flex-shrink: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
            justify-self: start;
        }

        .header-center {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .header-logo-img {
            height: 50px;
            width: auto;
        }

        .header-sponsor-logo {
            height: 60px;
            width: auto;
            max-width: 300px;
            object-fit: contain;
        }

        .header-datetime {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
            color: white;
            justify-self: end;
        }

        .header-time {
            font-size: 36px;
            font-weight: 700;
            line-height: 1;
        }

        .header-date {
            font-size: 18px;
            font-weight: 500;
            line-height: 1;
        }

        /* Sponsor Carousel */
        .sponsor-carousel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: white;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
            z-index: 1000;
        }

        .carousel-track {
            display: flex;
            align-items: center;
            height: 100%;
            gap: 40px;
            padding-left: 40px;
            animation: scroll var(--carousel-speed, 40s) linear infinite;
            will-change: transform;
        }

        .carousel-track:hover {
            animation-play-state: paused;
        }

        .carousel-logo {
            height: 50px;
            width: auto;
            max-width: 200px;
            object-fit: contain;
            flex-shrink: 0;
            transition: transform 0.3s ease;
        }

        .carousel-logo:hover {
            transform: scale(1.15);
        }

        @keyframes scroll {
            from {
                transform: translateX(0);
            }
            to {
                transform: translateX(-50%);
            }
        }

        /* Speed variants */
        .carousel-speed-slow {
            --carousel-speed: 60s;
        }

        .carousel-speed-medium {
            --carousel-speed: 40s;
        }

        .carousel-speed-fast {
            --carousel-speed: 25s;
        }

        /* Adjust activities wrapper when carousel is enabled */
        body.carousel-enabled .activities-wrapper {
            max-height: calc(100vh - 180px);
        }

        .activities-wrapper {
            flex: 1;
            padding: 20px;
            overflow: hidden;
            position: relative;
            max-height: calc(100vh - 100px);
        }

        .activities-wrapper::-webkit-scrollbar {
            display: none;
        }

        /* Schedule Template (Cards) */
        .template-schedule .activities-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            grid-auto-rows: minmax(140px, auto);
            gap: 16px;
            max-width: 1800px;
            margin: 0 auto;
            align-content: start;
        }

        .template-schedule .activity-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-left: 6px solid #EF7D00;
            padding: 20px;
            transition: all 0.3s;
            animation: slideIn 0.5s ease-out;
            position: relative;
            min-height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        .template-schedule .activity-card:hover {
            border-color: #EF7D00;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.2);
            transform: translateX(4px);
        }

        .template-schedule .activity-time {
            font-size: 22px;
            font-weight: 700;
            color: #EF7D00;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .template-schedule .activity-title {
            font-size: 20px;
            font-weight: 600;
            color: #000000;
            margin-bottom: 12px;
            line-height: 1.3;
        }

        .template-schedule .activity-location,
        .template-schedule .activity-area,
        .template-schedule .activity-user {
            font-size: 15px;
            color: #666;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .template-schedule .current-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #00C853;
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 700;
            animation: pulse 2s infinite;
        }

        .template-schedule .activity-card.current-activity {
            border-left-color: #00C853;
            background: linear-gradient(to right, #e8f5e9, white);
        }

        /* Table Template (Classic) */
        .template-table .activities-container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .template-table table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            animation: fadeIn 0.5s;
        }

        .template-table th {
            background: #EF7D00;
            color: white;
            padding: 18px 15px;
            text-align: left;
            font-size: 18px;
            font-weight: 700;
            border-bottom: 3px solid #e65100;
        }

        .template-table td {
            padding: 16px 15px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 17px;
            color: #333;
        }

        .template-table tr:nth-child(even) {
            background: #f9f9f9;
        }

        .template-table tr:hover {
            background: #fff3e0;
        }

        .template-table .time-cell {
            font-weight: 700;
            color: #EF7D00;
            white-space: nowrap;
            min-width: 130px;
        }

        .template-table .title-cell {
            font-weight: 600;
            color: #000;
        }

        .template-table .current-row {
            background: #e8f5e9 !important;
            border-left: 6px solid #00C853;
        }

        .template-table .current-row .time-cell::before {
            content: '‚ö° ';
        }

        /* Timeline Template */
        .template-timeline .activities-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .template-timeline .timeline-item {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
            position: relative;
            animation: slideIn 0.5s;
        }

        .template-timeline .timeline-time {
            min-width: 150px;
            text-align: right;
            padding-right: 30px;
            border-right: 4px solid #EF7D00;
            position: relative;
        }

        .template-timeline .timeline-time::after {
            content: '';
            position: absolute;
            right: -10px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            background: #EF7D00;
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 0 0 2px #EF7D00;
        }

        .template-timeline .timeline-time-text {
            font-size: 24px;
            font-weight: 700;
            color: #EF7D00;
            line-height: 1.2;
        }

        .template-timeline .timeline-duration {
            font-size: 14px;
            color: #666;
            margin-top: 4px;
        }

        .template-timeline .timeline-content {
            flex: 1;
            background: white;
            padding: 20px 25px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #e0e0e0;
            transition: all 0.3s;
        }

        .template-timeline .timeline-content:hover {
            border-left-color: #EF7D00;
            box-shadow: 0 4px 16px rgba(255, 107, 53, 0.2);
            transform: translateX(5px);
        }

        .template-timeline .timeline-title {
            font-size: 22px;
            font-weight: 700;
            color: #000;
            margin-bottom: 10px;
        }

        .template-timeline .timeline-details {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            font-size: 15px;
            color: #666;
        }

        .template-timeline .timeline-detail {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .template-timeline .timeline-item.current {
            animation: pulse 2s infinite;
        }

        .template-timeline .timeline-item.current .timeline-time::after {
            background: #00C853;
            box-shadow: 0 0 0 2px #00C853, 0 0 20px rgba(0, 200, 83, 0.5);
        }

        .template-timeline .timeline-item.current .timeline-time-text {
            color: #00C853;
        }

        .template-timeline .timeline-item.current .timeline-content {
            background: linear-gradient(to right, #e8f5e9, white);
            border-left-color: #00C853;
        }

        .template-timeline .current-badge {
            display: inline-block;
            background: #00C853;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            margin-left: 10px;
        }

        /* Compact Template */
        .template-compact .activities-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .template-compact .compact-item {
            background: white;
            padding: 18px 30px;
            margin-bottom: 12px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 30px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            transition: all 0.3s;
            animation: slideIn 0.5s;
            border-left: 4px solid transparent;
        }

        .template-compact .compact-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateX(5px);
            border-left-color: #EF7D00;
        }

        .template-compact .compact-time {
            min-width: 160px;
            font-size: 26px;
            font-weight: 700;
            color: #EF7D00;
            white-space: nowrap;
        }

        .template-compact .compact-title {
            flex: 1;
            font-size: 24px;
            font-weight: 600;
            color: #000;
        }

        .template-compact .compact-location {
            font-size: 20px;
            color: #666;
            min-width: 200px;
            text-align: right;
        }

        .template-compact .compact-item.current {
            background: linear-gradient(to right, #e8f5e9, white);
            border-left-color: #00C853;
        }

        .template-compact .compact-item.current .compact-time {
            color: #00C853;
        }

        .template-compact .compact-item.current .compact-time::before {
            content: '‚ö° ';
        }

        /* Offline indicators */
        .offline-indicator {
            position: fixed;
            top: 90px;
            right: 20px;
            background: #ff9800;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 10000;
            display: none;
            animation: slideInRight 0.5s;
        }

        .offline-indicator.show {
            display: block;
        }

        .cached-badge {
            background: #ff9800;
            color: white;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 10px;
            text-transform: uppercase;
        }

        .loading, .no-activities {
            text-align: center;
            font-size: 24px;
            color: #666;
            padding: 60px 20px;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.05);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 10px;
                padding: 15px 20px;
            }
            .header-logo {
                font-size: 28px;
            }
            .header-datetime {
                flex-direction: column;
                gap: 5px;
            }
            .template-schedule .activities-container {
                grid-template-columns: 1fr;
            }
            .template-compact .compact-item {
                flex-direction: column;
                align-items: flex-start;
            }
            .template-timeline .timeline-item {
                flex-direction: column;
            }
        }
    </style>
</head>
<body class="template-{{ json_template or 'schedule' }}{% if carousel_enabled %} carousel-enabled{% endif %}">
    <div class="offline-indicator" id="offlineIndicator">
        üì° Offline mode - Viser cached data
    </div>

    <div class="header">
        <div class="header-left">
            <img src="{% if magion_logo %}{{ magion_logo }}{% else %}/static/Magion_hvid.png{% endif %}" alt="MAGION" class="header-logo-img">
            <span id="cachedBadge" style="display: none;" class="cached-badge">Cached</span>
        </div>
        <div class="header-center">
            {% if sponsor_logo %}
            <img src="{{ sponsor_logo }}" alt="Hovedsponsor" class="header-sponsor-logo">
            {% endif %}
        </div>
        <div class="header-datetime">
            <div class="header-time" id="currentTime">--:--</div>
            <div class="header-date" id="currentDate">Indl√¶ser...</div>
        </div>
    </div>

    <div class="activities-wrapper">
        <div class="activities-container" id="activitiesContainer">
            <div class="loading">üîÑ Indl√¶ser aktiviteter...</div>
        </div>
    </div>

    {% if carousel_enabled and carousel_sponsors|length > 0 %}
    <!-- Sponsor Carousel -->
    <div class="sponsor-carousel carousel-speed-{{ carousel_speed }}">
        <div class="carousel-track">
            <!-- Original logos -->
            {% for logo in carousel_sponsors %}
            <img src="{{ logo }}" alt="Sponsor" class="carousel-logo">
            {% endfor %}
            <!-- Duplicate set 1 for seamless loop -->
            {% for logo in carousel_sponsors %}
            <img src="{{ logo }}" alt="Sponsor" class="carousel-logo" aria-hidden="true">
            {% endfor %}
            <!-- Duplicate set 2 for extra smooth scrolling -->
            {% for logo in carousel_sponsors %}
            <img src="{{ logo }}" alt="Sponsor" class="carousel-logo" aria-hidden="true">
            {% endfor %}
            <!-- Duplicate set 3 for extra smooth scrolling -->
            {% for logo in carousel_sponsors %}
            <img src="{{ logo }}" alt="Sponsor" class="carousel-logo" aria-hidden="true">
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <script>
        let rawJsonData = {{ json_data|safe }};
        const template = '{{ json_template }}' || 'schedule';
        const screenUuid = '{{ screen_uuid }}';
        let isOffline = false;
        let usingCachedData = false;

        console.log('üì¶ Raw JSON data:', rawJsonData);
        console.log('üé® Template:', template);

        // Cache key for this screen
        const CACHE_KEY = `json_data_${screenUuid}`;
        const CACHE_TIME_KEY = `json_data_time_${screenUuid}`;

        // Save JSON data to LocalStorage
        function cacheJsonData(data) {
            try {
                localStorage.setItem(CACHE_KEY, JSON.stringify(data));
                localStorage.setItem(CACHE_TIME_KEY, Date.now().toString());
                console.log('üíæ JSON data cached successfully');
            } catch (error) {
                console.error('Failed to cache JSON data:', error);
            }
        }

        // Load JSON data from LocalStorage
        function loadCachedJsonData() {
            try {
                const cached = localStorage.getItem(CACHE_KEY);
                const cacheTime = localStorage.getItem(CACHE_TIME_KEY);

                if (cached && cacheTime) {
                    const data = JSON.parse(cached);
                    const age = Date.now() - parseInt(cacheTime);
                    const ageHours = Math.floor(age / (1000 * 60 * 60));

                    console.log(`üì¶ Loaded cached data (${ageHours} hours old)`);
                    return data;
                }
            } catch (error) {
                console.error('Failed to load cached data:', error);
            }
            return null;
        }

        // Show/hide offline indicator
        function showOfflineIndicator() {
            const indicator = document.getElementById('offlineIndicator');
            const badge = document.getElementById('cachedBadge');
            if (indicator) indicator.classList.add('show');
            if (badge) badge.style.display = 'inline-block';
            isOffline = true;
        }

        function hideOfflineIndicator() {
            const indicator = document.getElementById('offlineIndicator');
            const badge = document.getElementById('cachedBadge');
            if (indicator) indicator.classList.remove('show');
            if (badge) badge.style.display = 'none';
            isOffline = false;
        }

        // If we have fresh data, cache it
        if (rawJsonData && Object.keys(rawJsonData).length > 0) {
            cacheJsonData(rawJsonData);
        } else {
            // Try to load from cache
            const cached = loadCachedJsonData();
            if (cached) {
                rawJsonData = cached;
                usingCachedData = true;
                showOfflineIndicator();
            }
        }

        // Online/offline detection
        window.addEventListener('online', () => {
            console.log('‚úÖ Connection restored');
            hideOfflineIndicator();
            setTimeout(() => window.location.reload(), 2000);
        });

        window.addEventListener('offline', () => {
            console.log('üì° Connection lost - switching to offline mode');
            showOfflineIndicator();
        });

        if (!navigator.onLine) {
            showOfflineIndicator();
        }

        // Parse JSON - handle multiple formats
        function parseJsonData(data) {
            let jsonData = [];
            if (Array.isArray(data)) {
                jsonData = data;
            } else if (data && data.infoskaerm) {
                jsonData = data.infoskaerm;
            } else if (typeof data === 'object') {
                const keys = Object.keys(data);
                for (let key of keys) {
                    if (Array.isArray(data[key])) {
                        jsonData = data[key];
                        break;
                    }
                }
            }
            return jsonData;
        }

        function displayActivities() {
            const container = document.getElementById('activitiesContainer');
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();

            const jsonData = parseJsonData(rawJsonData);
            console.log('‚úÖ Parsed activities:', jsonData.length);

            if (!jsonData || jsonData.length === 0) {
                container.innerHTML = '<div class="no-activities">üì≠ Ingen aktiviteter planlagt i dag</div>';
                return;
            }

            // Filter out activities that have ended (TilTid has passed)
            const activeData = jsonData.filter(activity => {
                const toTime = activity.tiltid || activity.TilTid || '';
                if (!toTime) return true; // If no end time, show it

                try {
                    const [toHour, toMin] = toTime.split(':').map(Number);
                    const toMinutes = toHour * 60 + toMin;
                    return currentTime < toMinutes; // Only show if current time is before end time
                } catch (e) {
                    return true; // If parse error, show it
                }
            });

            console.log(`üìä Showing ${activeData.length} of ${jsonData.length} activities (filtered ${jsonData.length - activeData.length} ended activities)`);

            if (activeData.length === 0) {
                container.innerHTML = '<div class="no-activities">üì≠ Ingen flere aktiviteter i dag</div>';
                return;
            }

            // Sort by time
            activeData.sort((a, b) => {
                const timeA = a.fratid || a.FraTid || '';
                const timeB = b.fratid || b.FraTid || '';
                return timeA.localeCompare(timeB);
            });

            container.innerHTML = '';

            // Render based on template
            switch(template) {
                case 'table':
                    renderTableTemplate(activeData, currentTime, container);
                    break;
                case 'timeline':
                    renderTimelineTemplate(activeData, currentTime, container);
                    break;
                case 'compact':
                    renderCompactTemplate(activeData, currentTime, container);
                    break;
                default: // 'schedule'
                    renderScheduleTemplate(activeData, currentTime, container);
            }

            // Scroll to top
            window.scrollTo(0, 0);
        }

        // Schedule Template (Cards)
        function renderScheduleTemplate(jsonData, currentTime, container) {
            jsonData.forEach((activity, index) => {
                const card = document.createElement('div');
                card.className = 'activity-card';
                card.style.animationDelay = `${(index % 20) * 0.05}s`;

                const fromTime = activity.fratid || activity.FraTid || '';
                const toTime = activity.tiltid || activity.TilTid || '';
                const isCurrent = isActivityCurrent(fromTime, toTime, currentTime);

                if (isCurrent) {
                    card.classList.add('current-activity');
                }

                let cardHTML = '';
                if (isCurrent) {
                    cardHTML += '<div class="current-badge">‚ö° NU</div>';
                }

                cardHTML += `
                    <div class="activity-time">üïê ${fromTime} - ${toTime}</div>
                    <div class="activity-title">${activity.titel || activity.Titel || 'Aktivitet'}</div>
                `;

                const location = activity.sted || activity.Sted || '';
                const area = activity.omraade || activity.Omr√•de || '';
                const user = activity.brugernavn || activity.Bruger || '';

                if (location) cardHTML += `<div class="activity-location">üìç ${location}</div>`;
                if (area) cardHTML += `<div class="activity-area">üè¢ ${area}</div>`;
                if (user) cardHTML += `<div class="activity-user">${user}</div>`;

                card.innerHTML = cardHTML;
                container.appendChild(card);
            });

            // Calculate exact height to show only full cards
            setTimeout(() => {
                const wrapper = document.querySelector('.activities-wrapper');
                const firstCard = container.querySelector('.activity-card');
                if (firstCard) {
                    const cardHeight = firstCard.offsetHeight;
                    const gap = 16;
                    const totalCardHeight = cardHeight + gap;
                    const availableHeight = wrapper.clientHeight - 40;
                    const visibleRows = Math.floor(availableHeight / totalCardHeight);
                    const exactHeight = (visibleRows * totalCardHeight) + 40;
                    wrapper.style.height = `${exactHeight}px`;
                    console.log(`üìê Card: ${cardHeight}px, Visible rows: ${visibleRows}`);
                }
            }, 200);
        }

        // Table Template (Classic)
        function renderTableTemplate(jsonData, currentTime, container) {
            const table = document.createElement('table');

            let html = `
                <thead>
                    <tr>
                        <th>Tid</th>
                        <th>Arrangement</th>
                        <th>Sted</th>
                        <th>Omr√•de</th>
                        <th>Bruger</th>
                    </tr>
                </thead>
                <tbody>
            `;

            jsonData.forEach(activity => {
                const fromTime = activity.fratid || activity.FraTid || '';
                const toTime = activity.tiltid || activity.TilTid || '';
                const title = activity.titel || activity.Titel || 'Aktivitet';
                const location = activity.sted || activity.Sted || '';
                const area = activity.omraade || activity.Omr√•de || '';
                const user = activity.brugernavn || activity.Bruger || '';

                const isCurrent = isActivityCurrent(fromTime, toTime, currentTime);
                const rowClass = isCurrent ? 'current-row' : '';

                html += `
                    <tr class="${rowClass}">
                        <td class="time-cell">${fromTime} - ${toTime}</td>
                        <td class="title-cell">${title}</td>
                        <td>${location}</td>
                        <td>${area}</td>
                        <td>${user}</td>
                    </tr>
                `;
            });

            html += '</tbody>';
            table.innerHTML = html;
            container.appendChild(table);
        }

        // Timeline Template (Visual)
        function renderTimelineTemplate(jsonData, currentTime, container) {
            jsonData.forEach((activity, index) => {
                const fromTime = activity.fratid || activity.FraTid || '';
                const toTime = activity.tiltid || activity.TilTid || '';
                const title = activity.titel || activity.Titel || 'Aktivitet';
                const location = activity.sted || activity.Sted || '';
                const area = activity.omraade || activity.Omr√•de || '';
                const user = activity.brugernavn || activity.Bruger || '';

                const isCurrent = isActivityCurrent(fromTime, toTime, currentTime);

                const item = document.createElement('div');
                item.className = 'timeline-item' + (isCurrent ? ' current' : '');
                item.style.animationDelay = `${index * 0.1}s`;

                let detailsHTML = '';
                if (location) detailsHTML += `<div class="timeline-detail">üìç ${location}</div>`;
                if (area) detailsHTML += `<div class="timeline-detail">üè¢ ${area}</div>`;
                if (user) detailsHTML += `<div class="timeline-detail">üë§ ${user}</div>`;

                item.innerHTML = `
                    <div class="timeline-time">
                        <div class="timeline-time-text">${fromTime}</div>
                        <div class="timeline-duration">${toTime}</div>
                    </div>
                    <div class="timeline-content">
                        <div class="timeline-title">
                            ${title}
                            ${isCurrent ? '<span class="current-badge">‚ö° NU</span>' : ''}
                        </div>
                        <div class="timeline-details">${detailsHTML}</div>
                    </div>
                `;

                container.appendChild(item);
            });
        }

        // Compact Template (Minimal)
        function renderCompactTemplate(jsonData, currentTime, container) {
            jsonData.forEach((activity, index) => {
                const fromTime = activity.fratid || activity.FraTid || '';
                const toTime = activity.tiltid || activity.TilTid || '';
                const title = activity.titel || activity.Titel || 'Aktivitet';
                const location = activity.sted || activity.Sted || '';

                const isCurrent = isActivityCurrent(fromTime, toTime, currentTime);

                const item = document.createElement('div');
                item.className = 'compact-item' + (isCurrent ? ' current' : '');
                item.style.animationDelay = `${index * 0.05}s`;

                item.innerHTML = `
                    <div class="compact-time">${fromTime} - ${toTime}</div>
                    <div class="compact-title">${title}</div>
                    <div class="compact-location">üìç ${location}</div>
                `;

                container.appendChild(item);
            });
        }

        // Check if activity is currently happening
        function isActivityCurrent(fromTime, toTime, currentTime) {
            if (!fromTime || !toTime) return false;
            try {
                const [fromHour, fromMin] = fromTime.split(':').map(Number);
                const [toHour, toMin] = toTime.split(':').map(Number);
                const fromMinutes = fromHour * 60 + fromMin;
                const toMinutes = toHour * 60 + toMin;
                return currentTime >= fromMinutes && currentTime < toMinutes;
            } catch (e) {
                return false;
            }
        }

        // Update date and time
        function updateDateTime() {
            const now = new Date();

            // Danish date format
            const dateOptions = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
            const dateStr = now.toLocaleDateString('da-DK', dateOptions);
            const formattedDate = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);

            // Time format
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');

            document.getElementById('currentDate').textContent = formattedDate;
            document.getElementById('currentTime').textContent = `${hours}:${minutes}:${seconds}`;
        }

        // Check for settings changes (template, carousel, etc)
        let currentSettings = {
            json_template: '{{ json_template }}',
            carousel_enabled: {{ 'true' if carousel_enabled else 'false' }},
            carousel_speed: '{{ carousel_speed }}',
            carousel_sponsors_count: {{ carousel_sponsors|length if carousel_sponsors else 0 }}
        };

        setInterval(() => {
            // Skip check if offline
            if (!navigator.onLine) {
                console.log('Skipping settings check - offline');
                return;
            }

            fetch(`/api/screen/${screenUuid}/settings`)
                .then(response => response.json())
                .then(newSettings => {
                    // Check if any relevant settings have changed
                    let needsReload = false;

                    if (newSettings.json_template !== currentSettings.json_template) {
                        console.log(`Template changed: ${currentSettings.json_template} ‚Üí ${newSettings.json_template} - reloading`);
                        needsReload = true;
                    }

                    if (newSettings.carousel_enabled !== currentSettings.carousel_enabled) {
                        console.log(`Carousel enabled changed: ${currentSettings.carousel_enabled} ‚Üí ${newSettings.carousel_enabled} - reloading`);
                        needsReload = true;
                    }

                    if (newSettings.carousel_speed !== currentSettings.carousel_speed) {
                        console.log(`Carousel speed changed: ${currentSettings.carousel_speed} ‚Üí ${newSettings.carousel_speed} - reloading`);
                        needsReload = true;
                    }

                    if (newSettings.carousel_sponsors_count !== currentSettings.carousel_sponsors_count) {
                        console.log(`Carousel sponsors changed: ${currentSettings.carousel_sponsors_count} ‚Üí ${newSettings.carousel_sponsors_count} - reloading`);
                        needsReload = true;
                    }

                    if (needsReload) {
                        window.location.reload();
                    }
                })
                .catch(error => {
                    console.error('Error checking settings (kan v√¶re offline):', error);
                });
        }, 15000); // Check every 15 seconds

        // Initialize
        updateDateTime();
        setInterval(updateDateTime, 1000);

        displayActivities();
        setInterval(displayActivities, 60 * 1000); // Update every minute
    </script>
</body>
</html>
