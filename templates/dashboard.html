{% extends "base.html" %}

{% block title %}Dashboard - Magion Multi-Screen{% endblock %}

{% block extra_css %}
<style>
    * { box-sizing: border-box; }

    body { background: #f5f7fa; }

    .tabs-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .tab-content {
        display: none;
        padding: 30px;
    }

    .tab-content.active {
        display: block;
    }

    .screen-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e9ecef;
    }

    .screen-info h2 {
        margin: 0 0 10px 0;
        color: #2d3748;
    }

    .screen-meta {
        display: flex;
        gap: 20px;
        color: #718096;
        font-size: 14px;
    }

    .screen-actions {
        display: flex;
        gap: 10px;
    }

    .section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .section h3 {
        margin: 0 0 15px 0;
        color: #2d3748;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .upload-zone {
        border: 2px dashed #cbd5e0;
        border-radius: 8px;
        padding: 30px;
        text-align: center;
        background: white;
        cursor: pointer;
        transition: all 0.2s;
    }

    .upload-zone:hover {
        border-color: #667eea;
        background: #f0f5ff;
    }

    .upload-zone.dragover {
        border-color: #667eea;
        background: #e6f0ff;
    }

    .media-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }

    .media-card {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: move;
        position: relative;
    }

    .media-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .media-card.selected {
        box-shadow: 0 0 0 3px #667eea;
    }

    .media-checkbox {
        position: absolute;
        top: 8px;
        left: 8px;
        width: 22px;
        height: 22px;
        cursor: pointer;
        z-index: 5;
        accent-color: #667eea;
        background: white;
        border: 2px solid #cbd5e0;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .media-checkbox:checked {
        background: #667eea;
        border-color: #667eea;
    }

    .bulk-actions {
        position: sticky;
        top: 0;
        background: #667eea;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        margin-bottom: 15px;
        display: none;
        align-items: center;
        justify-content: space-between;
        z-index: 10;
    }

    .bulk-actions.visible {
        display: flex;
    }

    .media-preview {
        width: 100%;
        height: 120px;
        object-fit: cover;
        background: #e2e8f0;
    }

    .media-info {
        padding: 10px;
    }

    .media-title {
        font-size: 11px;
        color: #2d3748;
        margin-bottom: 8px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .media-controls {
        display: flex;
        gap: 4px;
        margin-top: 8px;
    }

    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
    }

    .btn-primary {
        background: #667eea;
        color: white;
    }

    .btn-primary:hover {
        background: #5568d3;
    }

    .btn-secondary {
        background: #e2e8f0;
        color: #2d3748;
    }

    .btn-secondary:hover {
        background: #cbd5e0;
    }

    .btn-danger {
        background: #fc8181;
        color: white;
    }

    .btn-danger:hover {
        background: #f56565;
    }

    .btn-small {
        padding: 5px 10px;
        font-size: 11px;
    }

    .form-group {
        margin-bottom: 16px;
    }

    .form-group label {
        display: block;
        margin-bottom: 6px;
        color: #4a5568;
        font-size: 14px;
        font-weight: 500;
    }

    .form-group input,
    .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #cbd5e0;
        border-radius: 6px;
        font-size: 14px;
    }

    .form-group input:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .toggle-switch {
        position: relative;
        width: 50px;
        height: 26px;
        background: #cbd5e0;
        border-radius: 13px;
        cursor: pointer;
        transition: background 0.3s;
        display: inline-block;
        vertical-align: middle;
    }

    .toggle-switch.active {
        background: #48bb78;
    }

    .toggle-switch::after {
        content: '';
        position: absolute;
        top: 3px;
        left: 3px;
        width: 20px;
        height: 20px;
        background: white;
        border-radius: 50%;
        transition: transform 0.3s;
    }

    .toggle-switch.active::after {
        transform: translateX(24px);
    }

    .qr-display {
        text-align: center;
        padding: 20px;
        background: white;
        border-radius: 8px;
    }

    .qr-display img {
        max-width: 250px;
        margin: 20px auto;
    }

    .url-display {
        background: #f8f9fa;
        padding: 12px;
        border-radius: 6px;
        font-family: monospace;
        font-size: 12px;
        word-break: break-all;
        margin-top: 10px;
    }

    .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }

    .badge-success {
        background: #c6f6d5;
        color: #22543d;
    }

    .badge-warning {
        background: #feebc8;
        color: #7c2d12;
    }

    .badge-info {
        background: #bee3f8;
        color: #2c5282;
    }

    .redirect-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
    }

    .redirect-section input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
        margin-right: 10px;
    }

    .redirect-section input[type="url"] {
        background: rgba(255,255,255,0.9);
        border: 1px solid rgba(255,255,255,0.3);
    }

    .grid-2col {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    @media (max-width: 968px) {
        .grid-2col {
            grid-template-columns: 1fr;
        }
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #718096;
    }

    .empty-state-icon {
        font-size: 64px;
        margin-bottom: 16px;
        opacity: 0.5;
    }

    .screen-menu {
        position: relative;
        display: inline-block;
    }

    .screen-menu-button {
        background: transparent;
        border: none;
        color: #718096;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 16px;
        transition: all 0.2s;
    }

    .screen-menu-button:hover {
        background: rgba(0,0,0,0.05);
        color: #2d3748;
    }

    .screen-menu-dropdown {
        display: none;
        position: absolute;
        right: 0;
        top: 100%;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        min-width: 200px;
        z-index: 1000;
        margin-top: 4px;
    }

    .screen-menu-dropdown.visible {
        display: block;
    }

    .screen-menu-item {
        padding: 12px 16px;
        cursor: pointer;
        transition: background 0.2s;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .screen-menu-item:last-child {
        border-bottom: none;
    }

    .screen-menu-item:hover {
        background: #f7fafc;
    }

    .screen-menu-item.danger:hover {
        background: #fff5f5;
        color: #c53030;
    }
</style>
{% endblock %}

{% block content %}
<div style="max-width: 1400px; margin: 0 auto;">
    <!-- Content Container -->
    <div class="tabs-container">

        <!-- GLOBAL MEDIA TAB -->
        <div id="tab-global" class="tab-content active">
            <div class="screen-header">
                <div class="screen-info">
                    <h2>üåç Global Media</h2>
                    <p style="color: #718096; margin: 0;">Media der vises p√• alle sk√¶rme som ikke har specifikt tildelt media</p>
                </div>
            </div>

            <div class="section">
                <h3>üì§ Upload Global Media</h3>
                <form method="POST" action="{{ url_for('upload_file') }}" enctype="multipart/form-data" id="globalUploadForm">
                    <div class="upload-zone" onclick="document.getElementById('globalFileInput').click()">
                        <input type="file" id="globalFileInput" name="file" multiple accept="image/*,video/*" style="display: none;" onchange="handleGlobalFileSelect(this)">
                        <div style="font-size: 48px; margin-bottom: 10px;">üìÅ</div>
                        <div style="font-size: 16px; color: #4a5568; margin-bottom: 5px;">Klik for at v√¶lge filer</div>
                        <div style="font-size: 12px; color: #718096;">eller tr√¶k og slip her</div>
                    </div>
                </form>
            </div>

            <div class="section">
                <h3>üé¨ Global Media Liste ({{ media_files|selectattr('is_global')|list|length }} filer)</h3>

                <div class="bulk-actions" id="globalBulkActions">
                    <span id="globalSelectedCount">0 filer valgt</span>
                    <button onclick="bulkDeleteGlobal()" class="btn btn-danger">üóëÔ∏è Slet valgte</button>
                </div>

                <div class="media-grid">
                    {% for media in media_files %}
                    {% if media.is_global %}
                    <div class="media-card" id="global-media-{{ media.id }}">
                        <input type="checkbox" class="media-checkbox global-media-checkbox" data-media-id="{{ media.id }}" onchange="updateGlobalBulkActions()">
                        {% if media.media_type == 'image' %}
                            <img src="/media/{{ media.filename }}" class="media-preview">
                        {% else %}
                            <video src="/media/{{ media.filename }}" class="media-preview"></video>
                        {% endif %}
                        <div class="media-info">
                            <div class="media-title">{{ media.original_filename }}</div>
                            {% if media.expire_at %}
                            <div style="font-size: 10px; color: #ed8936; margin-top: 4px;">
                                ‚è∞ {{ media.expire_at.strftime('%d/%m %H:%M') }}
                                {% if media.auto_delete %}üóëÔ∏è{% endif %}
                            </div>
                            {% endif %}
                            <div class="media-controls">
                                <div class="toggle-switch {% if media.active %}active{% endif %}" onclick="toggleMedia({{ media.id }}, this)"></div>
                                <button onclick="openExpireModal({{ media.id }}, '{{ media.original_filename }}', '{{ media.expire_at.isoformat() if media.expire_at else '' }}', {{ 'true' if media.auto_delete else 'false' }})" class="btn btn-secondary btn-small" title="S√¶t udl√∏bsdato">‚è∞</button>
                                <button onclick="deleteMedia({{ media.id }})" class="btn btn-danger btn-small">Slet</button>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                {% if media_files|selectattr('is_global')|list|length == 0 %}
                <div class="empty-state">
                    <div class="empty-state-icon">üì≠</div>
                    <p>Ingen global media uploadet endnu</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- SCREEN TABS -->
        {% for screen in screens %}
        <div id="tab-screen-{{ screen.id }}" class="tab-content">
            <div class="screen-header">
                <div class="screen-info">
                    <h2>{{ screen.name }}</h2>
                    <div class="screen-meta">
                        <span>üìç {{ screen.location or 'Ingen lokation' }}</span>
                        <span>üîë {{ screen.pairing_code }}</span>
                        <span>
                            {% if screen.active %}
                            <span class="badge badge-success">Aktiv</span>
                            {% else %}
                            <span class="badge badge-warning">Inaktiv</span>
                            {% endif %}
                        </span>
                    </div>
                </div>
                <div class="screen-actions">
                    <button onclick="showQRCode({{ screen.id }})" class="btn btn-secondary">üì± QR Kode</button>
                    <button onclick="copyScreenURL('{{ url_for('display_screen', screen_uuid=screen.uuid, _external=True) }}')" class="btn btn-secondary">üîó Kopi URL</button>
                    <div class="toggle-switch {% if screen.active %}active{% endif %}" onclick="toggleScreen({{ screen.id }}, this)"></div>
                    <div class="screen-menu">
                        <button class="screen-menu-button" onclick="toggleScreenMenu({{ screen.id }}, event)">‚ãÆ</button>
                        <div class="screen-menu-dropdown" id="screenMenu{{ screen.id }}">
                            <div class="screen-menu-item" onclick="openEditScreenModal({{ screen.id }}, '{{ screen.name }}', '{{ screen.location or '' }}', '{{ screen.description or '' }}')">
                                ‚úèÔ∏è Rediger sk√¶rm
                            </div>
                            {% if user.role == 'admin' or user.is_admin %}
                            <div class="screen-menu-item danger" onclick="confirmDeleteScreen({{ screen.id }}, '{{ screen.name }}')">
                                üóëÔ∏è Slet sk√¶rm
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid-2col">
                <div>
                    <div class="section">
                        <h3>üì§ Upload til {{ screen.name }}</h3>
                        <div class="upload-zone" onclick="document.getElementById('screenFileInput{{ screen.id }}').click()" data-screen-id="{{ screen.id }}">
                            <input type="file" id="screenFileInput{{ screen.id }}" multiple accept="image/*,video/*" style="display: none;" onchange="handleScreenFileSelect(this, {{ screen.id }})">
                            <div style="font-size: 48px; margin-bottom: 10px;">üìÅ</div>
                            <div style="font-size: 16px; color: #4a5568; margin-bottom: 5px;">Upload media kun til denne sk√¶rm</div>
                            <div style="font-size: 12px; color: #718096;">Klik eller tr√¶k filer her</div>
                        </div>
                    </div>

                    <div class="redirect-section">
                        <h3 style="color: white; margin: 0 0 15px 0;">üéØ Display Mode</h3>
                        <form method="POST" action="{{ url_for('update_screen_settings', screen_id=screen.id) }}" id="displayModeForm{{ screen.id }}" enctype="multipart/form-data">
                            {% set current_mode = screen.display_mode or 'media' %}
                            {% if screen.redirect_enabled and screen.redirect_url %}
                                {% set current_mode = 'redirect' %}
                            {% endif %}

                            <div class="form-group" style="margin-bottom: 20px;">
                                <label style="color: white; margin-bottom: 10px; display: block; font-weight: 600;">V√¶lg visningstype:</label>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <label style="display: flex; align-items: center; color: white; cursor: pointer; padding: 8px; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">
                                        <input type="radio" name="display_mode" value="media" {% if current_mode == 'media' %}checked{% endif %} onchange="toggleDisplayModeFields{{ screen.id }}()" style="margin-right: 8px;">
                                        <span>üì∫ Media Rotation (billeder/videoer)</span>
                                    </label>
                                    <label style="display: flex; align-items: center; color: white; cursor: pointer; padding: 8px; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">
                                        <input type="radio" name="display_mode" value="redirect" {% if current_mode == 'redirect' %}checked{% endif %} onchange="toggleDisplayModeFields{{ screen.id }}()" style="margin-right: 8px;">
                                        <span>üîó URL Redirect</span>
                                    </label>
                                    <label style="display: flex; align-items: center; color: white; cursor: pointer; padding: 8px; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">
                                        <input type="radio" name="display_mode" value="iframe" {% if current_mode == 'iframe' %}checked{% endif %} onchange="toggleDisplayModeFields{{ screen.id }}()" style="margin-right: 8px;">
                                        <span>üñºÔ∏è iFrame (vis ekstern side)</span>
                                    </label>
                                    <label style="display: flex; align-items: center; color: white; cursor: pointer; padding: 8px; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">
                                        <input type="radio" name="display_mode" value="json_api" {% if current_mode == 'json_api' %}checked{% endif %} onchange="toggleDisplayModeFields{{ screen.id }}()" style="margin-right: 8px;">
                                        <span>üìä JSON API (hent data)</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Redirect URL field -->
                            <div class="form-group mode-field mode-redirect{{ screen.id }}" style="display: none;">
                                <label style="color: white;">üîó Redirect URL</label>
                                <input type="url" name="redirect_url" value="{{ screen.redirect_url or '' }}" placeholder="https://example.com">
                                <div style="font-size: 11px; color: rgba(255,255,255,0.7); margin-top: 4px;">Sk√¶rmen viderestiller til denne URL</div>
                            </div>

                            <!-- iFrame URL field -->
                            <div class="mode-field mode-iframe{{ screen.id }}" style="display: none;">
                                <div class="form-group">
                                    <label style="color: white;">üñºÔ∏è iFrame URL</label>
                                    <input type="url" name="iframe_url" value="{{ screen.iframe_url or '' }}" placeholder="https://example.com">
                                    <div style="font-size: 11px; color: rgba(255,255,255,0.7); margin-top: 4px;">Vis ekstern hjemmeside i fuld sk√¶rm</div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="form-group">
                                        <label style="color: white;">‚Üê Venstre Margin (px)</label>
                                        <input type="number" name="iframe_margin_left" value="{{ screen.iframe_margin_left or 0 }}" min="0" max="1000" placeholder="0">
                                        <div style="font-size: 11px; color: rgba(255,255,255,0.7); margin-top: 4px;">Skub indhold fra venstre</div>
                                    </div>
                                    <div class="form-group">
                                        <label style="color: white;">H√∏jre Margin (px) ‚Üí</label>
                                        <input type="number" name="iframe_margin_right" value="{{ screen.iframe_margin_right or 0 }}" min="0" max="1000" placeholder="0">
                                        <div style="font-size: 11px; color: rgba(255,255,255,0.7); margin-top: 4px;">Skub indhold fra h√∏jre</div>
                                    </div>
                                </div>
                            </div>

                            <!-- JSON API fields -->
                            <div class="mode-field mode-json_api{{ screen.id }}" style="display: none;">
                                <div class="form-group">
                                    <label style="color: white;">üìä JSON API URL</label>
                                    <input type="url" name="json_api_url" value="{{ screen.json_api_url or '' }}" placeholder="https://api.example.com/data">
                                    <div style="font-size: 11px; color: rgba(255,255,255,0.7); margin-top: 4px;">URL til JSON data (f.eks. aktivitetsplan)</div>
                                </div>
                                <div class="form-group">
                                    <label style="color: white;">üé® Display Template</label>
                                    <select name="json_template" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white;">
                                        <option value="schedule" {% if screen.json_template == 'schedule' or not screen.json_template %}selected{% endif %}>üìÖ Kort Visning (cards)</option>
                                        <option value="table" {% if screen.json_template == 'table' %}selected{% endif %}>üìä Tabel - Lille (kompakt)</option>
                                        <option value="table-large" {% if screen.json_template == 'table-large' %}selected{% endif %}>üìä Tabel - Stor (romslig)</option>
                                        <option value="timeline" {% if screen.json_template == 'timeline' %}selected{% endif %}>‚è∞ Tidslinje (visuelt)</option>
                                        <option value="compact" {% if screen.json_template == 'compact' %}selected{% endif %}>üìã Kompakt - Lille</option>
                                        <option value="compact-large" {% if screen.json_template == 'compact-large' %}selected{% endif %}>üìã Kompakt - Stor</option>
                                    </select>
                                    <div style="font-size: 11px; color: rgba(255,255,255,0.7); margin-top: 4px;">V√¶lg hvordan aktivitetsdata skal vises p√• sk√¶rmen</div>
                                </div>
                                <div class="form-group">
                                    <label style="color: white;">üé® MAGION Logo</label>
                                    {% if screen.magion_logo_path %}
                                    <div style="margin-bottom: 10px;">
                                        <img src="{{ screen.magion_logo_path }}" alt="MAGION logo" style="max-width: 200px; max-height: 60px; background: #EF7D00; padding: 5px; border-radius: 4px;">
                                    </div>
                                    {% endif %}
                                    <input type="file" name="magion_logo" accept="image/*" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white;">
                                    <div style="font-size: 11px; color: rgba(255,255,255,0.7); margin-top: 4px;">Upload MAGION logo (hvid logo anbefalet). Lad tom for at bruge standard logo.</div>
                                </div>

                                <div class="form-group">
                                    <label style="color: white;">üè¢ Hovedsponsor Logo</label>
                                    {% if screen.sponsor_logo_path %}
                                    <div style="margin-bottom: 10px;">
                                        <img src="{{ screen.sponsor_logo_path }}" alt="Sponsor logo" style="max-width: 200px; max-height: 60px; background: white; padding: 5px; border-radius: 4px;">
                                    </div>
                                    {% endif %}
                                    <input type="file" name="sponsor_logo" accept="image/*" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white;">
                                    <div style="font-size: 11px; color: rgba(255,255,255,0.7); margin-top: 4px;">Upload sponsor logo der vises centreret i header (anbefalet: hvid logo p√• transparent baggrund)</div>
                                </div>

                                <div class="form-group" style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 20px; margin-top: 20px;">
                                    <label style="color: white; font-size: 16px; font-weight: 600; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                                        üé† Sponsor Carousel (bund af sk√¶rm)
                                        <input type="checkbox" name="carousel_enabled" value="true" {% if screen.carousel_enabled %}checked{% endif %}
                                               style="width: 20px; height: 20px; cursor: pointer;">
                                    </label>
                                    <div style="font-size: 11px; color: rgba(255,255,255,0.7); margin-bottom: 15px;">Aktiver for at vise scrollende sponsor logoer i bunden af sk√¶rmen</div>

                                    <div id="carouselSettings{{ screen.id }}" style="{% if not screen.carousel_enabled %}display: none;{% endif %}">
                                        <div class="form-group">
                                            <label style="color: white;">‚ö° Scroll Hastighed</label>
                                            <select name="carousel_speed" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white;">
                                                <option value="slow" {% if screen.carousel_speed == 'slow' %}selected{% endif %}>üêå Langsom (60s)</option>
                                                <option value="medium" {% if screen.carousel_speed == 'medium' or not screen.carousel_speed %}selected{% endif %}>üö∂ Medium (40s)</option>
                                                <option value="fast" {% if screen.carousel_speed == 'fast' %}selected{% endif %}>üèÉ Hurtig (25s)</option>
                                            </select>
                                        </div>

                                        <div class="form-group">
                                            <label style="color: white;">üì§ Upload Sponsor Logoer</label>
                                            <div id="carouselLogos{{ screen.id }}" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px;">
                                                {% for sponsor in screen.carousel_sponsors %}
                                                <div class="carousel-logo-item" style="position: relative; background: white; padding: 5px; border-radius: 4px;">
                                                    <img src="{{ sponsor.filename }}" alt="{{ sponsor.original_filename }}" style="height: 50px; width: auto; max-width: 120px; object-fit: contain;">
                                                    <button type="button" onclick="deleteCarouselSponsor({{ screen.id }}, {{ sponsor.id }})" style="position: absolute; top: -5px; right: -5px; background: #e74c3c; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px; line-height: 1;">√ó</button>
                                                </div>
                                                {% endfor %}
                                            </div>
                                            <input type="file" id="carouselUpload{{ screen.id }}" multiple accept="image/*" style="display: none;" onchange="uploadCarouselSponsors({{ screen.id }})">
                                            <button type="button" onclick="document.getElementById('carouselUpload{{ screen.id }}').click()" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; cursor: pointer;">
                                                ‚ûï Tilf√∏j Sponsor Logoer
                                            </button>
                                            <div style="font-size: 11px; color: rgba(255,255,255,0.7); margin-top: 4px;">Upload flere sponsor logoer (PNG/JPG med transparent baggrund anbefalet)</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <button type="submit" class="btn" style="background: white; color: #667eea; width: 100%;">üíæ Gem Indstillinger</button>
                        </form>
                    </div>

                    <script>
                    function toggleDisplayModeFields{{ screen.id }}() {
                        const form = document.getElementById('displayModeForm{{ screen.id }}');
                        const selectedMode = form.querySelector('input[name="display_mode"]:checked').value;

                        // Hide all mode-specific fields
                        form.querySelectorAll('.mode-field').forEach(field => {
                            field.style.display = 'none';
                        });

                        // Show fields for selected mode
                        form.querySelectorAll('.mode-' + selectedMode + '{{ screen.id }}').forEach(field => {
                            field.style.display = 'block';
                        });
                    }

                    // Initialize on page load
                    toggleDisplayModeFields{{ screen.id }}();

                    // Toggle carousel settings visibility
                    document.querySelector('input[name="carousel_enabled"]').addEventListener('change', function() {
                        const settings = document.getElementById('carouselSettings{{ screen.id }}');
                        settings.style.display = this.checked ? 'block' : 'none';
                    });

                    // Upload carousel sponsors
                    async function uploadCarouselSponsors(screenId) {
                        const fileInput = document.getElementById('carouselUpload' + screenId);
                        const files = fileInput.files;

                        if (files.length === 0) return;

                        const formData = new FormData();
                        for (let i = 0; i < files.length; i++) {
                            formData.append('carousel_sponsors', files[i]);
                        }

                        try {
                            const response = await fetch(`/screen/${screenId}/carousel/upload`, {
                                method: 'POST',
                                body: formData
                            });

                            const result = await response.json();
                            if (result.success) {
                                location.reload(); // Reload to show new logos
                            }
                        } catch (error) {
                            alert('Fejl ved upload: ' + error.message);
                        }
                    }

                    // Delete carousel sponsor
                    async function deleteCarouselSponsor(screenId, sponsorId) {
                        if (!confirm('Slet dette sponsor logo?')) return;

                        try {
                            const response = await fetch(`/screen/${screenId}/carousel/${sponsorId}/delete`, {
                                method: 'POST'
                            });

                            const result = await response.json();
                            if (result.success) {
                                location.reload(); // Reload to update view
                            }
                        } catch (error) {
                            alert('Fejl ved sletning: ' + error.message);
                        }
                    }
                    </script>
                </div>

                <div>
                    <div class="section">
                        <h3>üé¨ Media p√• {{ screen.name }} ({{ screen.media_associations|length }} filer)</h3>

                        <div class="bulk-actions" id="screenBulkActions{{ screen.id }}">
                            <span id="screenSelectedCount{{ screen.id }}">0 filer valgt</span>
                            <button onclick="bulkDeleteScreen({{ screen.id }})" class="btn btn-danger">üóëÔ∏è Slet valgte</button>
                        </div>

                        <div class="media-grid" id="screenMediaGrid{{ screen.id }}">
                            {% for assoc in screen.media_associations %}
                            {% set media = assoc.media %}
                            <div class="media-card" id="screen-{{ screen.id }}-media-{{ media.id }}">
                                <input type="checkbox" class="media-checkbox screen-media-checkbox" data-screen-id="{{ screen.id }}" data-media-id="{{ media.id }}" onchange="updateScreenBulkActions({{ screen.id }})">
                                {% if media.media_type == 'image' %}
                                    <img src="/media/{{ media.filename }}" class="media-preview">
                                {% else %}
                                    <video src="/media/{{ media.filename }}" class="media-preview"></video>
                                {% endif %}
                                <div class="media-info">
                                    <div class="media-title">{{ media.original_filename }}</div>
                                    <div style="font-size: 10px; color: #718096; margin-top: 4px; display: flex; align-items: center; gap: 4px;">
                                        ‚è±Ô∏è Varighed:
                                        <input type="number"
                                               class="duration-input"
                                               value="{{ ((assoc.duration if assoc.duration else media.duration) / 1000)|int }}"
                                               onchange="updateScreenMediaDuration({{ screen.id }}, {{ media.id }}, this.value * 1000)"
                                               style="width: 50px; padding: 2px 4px; border: 1px solid #cbd5e0; border-radius: 3px; font-size: 10px;">
                                        sek
                                        {% if assoc.duration %}
                                        <span style="color: #667eea;" title="Custom duration for this screen">üéØ</span>
                                        {% endif %}
                                    </div>
                                    {% if media.expire_at %}
                                    <div style="font-size: 10px; color: #ed8936; margin-top: 4px;">
                                        ‚è∞ {{ media.expire_at.strftime('%d/%m %H:%M') }}
                                        {% if media.auto_delete %}üóëÔ∏è{% endif %}
                                    </div>
                                    {% endif %}
                                    <div class="media-controls">
                                        <div class="toggle-switch {% if media.active %}active{% endif %}" onclick="toggleMedia({{ media.id }}, this)"></div>
                                        <button onclick="openExpireModal({{ media.id }}, '{{ media.original_filename }}', '{{ media.expire_at.isoformat() if media.expire_at else '' }}', {{ 'true' if media.auto_delete else 'false' }})" class="btn btn-secondary btn-small" title="S√¶t udl√∏bsdato">‚è∞</button>
                                        <button onclick="deleteMedia({{ media.id }})" class="btn btn-danger btn-small">Slet</button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% if screen.media_associations|length == 0 %}
                        <div class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <p>Ingen media uploadet til denne sk√¶rm</p>
                            <p style="font-size: 12px;">Denne sk√¶rm viser global media</p>
                        </div>
                        {% endif %}
                    </div>

                    <div class="qr-display" id="qrDisplay{{ screen.id }}" style="display: none;">
                        <h3>QR Kode - {{ screen.name }}</h3>
                        <img id="qrImage{{ screen.id }}" src="" alt="QR Code">
                        <div class="url-display" id="qrURL{{ screen.id }}"></div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}

        {% if screens|length == 0 %}
        <div class="tab-content active">
            <div class="empty-state">
                <div class="empty-state-icon">üì∫</div>
                <h3>Ingen sk√¶rme oprettet endnu</h3>
                <p>Klik p√• "Opret Ny Sk√¶rm" for at komme i gang</p>
            </div>
        </div>
        {% endif %}

        <!-- SYSTEM INFO TAB -->
        <div id="tab-system-info" class="tab-content">
            <div class="screen-header">
                <div class="screen-info">
                    <h2>üíæ System Information</h2>
                    <p style="color: #718096; margin: 0;">Cache status og system ressourcer</p>
                </div>
            </div>

            <div class="section">
                <h3>üìä Cache Statistik</h3>
                <div id="cacheStats" style="padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <p style="text-align: center; color: #718096;">Indl√¶ser cache information...</p>
                </div>
            </div>

            <div class="section" style="margin-top: 20px;">
                <h3>üßπ Cache Kontrol</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="refreshCacheInfo()" class="btn btn-primary" style="flex: 1; min-width: 200px;">
                        üîÑ Genindl√¶s Information
                    </button>
                    <button onclick="clearBrowserCache()" class="btn btn-warning" style="flex: 1; min-width: 200px;">
                        üóëÔ∏è Ryd Browser Cache (Admin)
                    </button>
                </div>
                <p style="margin-top: 10px; font-size: 12px; color: #718096;">
                    üí° Service Worker cache ryddes automatisk n√•r sk√¶rme loader nye filer.
                    Browser cache limits: 100 MB eller 100 filer per enhed.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- CREATE SCREEN MODAL -->
<div id="createScreenModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%;">
        <h2 style="margin-top: 0;">Opret Ny Sk√¶rm</h2>
        <form method="POST" action="{{ url_for('create_screen') }}">
            <div class="form-group">
                <label>Navn *</label>
                <input type="text" name="name" required placeholder="fx. Reception Sk√¶rm">
            </div>
            <div class="form-group">
                <label>Lokation</label>
                <input type="text" name="location" placeholder="fx. Hovedindgang">
            </div>
            <div class="form-group">
                <label>Beskrivelse</label>
                <textarea name="description" rows="3"></textarea>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn btn-primary" style="flex: 1;">Opret Sk√¶rm</button>
                <button type="button" onclick="closeCreateScreenModal()" class="btn btn-secondary" style="flex: 1;">Annuller</button>
            </div>
        </form>
    </div>
</div>

<!-- EDIT SCREEN MODAL -->
<div id="editScreenModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%;">
        <h2 style="margin-top: 0;">Rediger Sk√¶rm</h2>
        <form id="editScreenForm" method="POST">
            <input type="hidden" id="editScreenId" name="screen_id">
            <div class="form-group">
                <label>Navn *</label>
                <input type="text" id="editScreenName" name="name" required placeholder="fx. Reception Sk√¶rm">
            </div>
            <div class="form-group">
                <label>Lokation</label>
                <input type="text" id="editScreenLocation" name="location" placeholder="fx. Hovedindgang">
            </div>
            <div class="form-group">
                <label>Beskrivelse</label>
                <textarea id="editScreenDescription" name="description" rows="3"></textarea>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn btn-primary" style="flex: 1;">Gem √Ündringer</button>
                <button type="button" onclick="closeEditScreenModal()" class="btn btn-secondary" style="flex: 1;">Annuller</button>
            </div>
        </form>
    </div>
</div>

<!-- EXPIRE MODAL -->
<div id="expireModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%;">
        <h2 style="margin-top: 0;">‚è∞ S√¶t Udl√∏bsdato</h2>
        <p style="color: #718096; margin-bottom: 20px;" id="expireModalFileName"></p>

        <div class="form-group">
            <label>Udl√∏bsdato og tid</label>
            <input type="datetime-local" id="expireDateTime" class="form-control" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px;">
            <small style="color: #718096; display: block; margin-top: 5px;">N√•r denne dato/tid n√•s, vil mediet blive deaktiveret eller slettet</small>
        </div>

        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="expireAutoDelete" style="width: 20px; height: 20px;">
                <span>üóëÔ∏è Auto-slet filen n√•r den udl√∏ber</span>
            </label>
            <small style="color: #718096; display: block; margin-top: 5px;">Hvis ikke markeret, bliver filen kun deaktiveret</small>
        </div>

        <div style="background: #f0f5ff; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea; margin: 15px 0;">
            <strong style="color: #667eea;">üí° Tips:</strong>
            <ul style="margin: 10px 0 0 20px; font-size: 13px; color: #4a5568; line-height: 1.6;">
                <li>Perfekt til kampagner med deadline</li>
                <li>S√¶sonbaseret indhold (jul, p√•ske, osv.)</li>
                <li>Tidsbestemt information</li>
                <li>Cleanup k√∏rer automatisk hver time</li>
            </ul>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button onclick="saveExpireSettings()" class="btn btn-primary" style="flex: 1;">üíæ Gem</button>
            <button onclick="clearExpireSettings()" class="btn btn-secondary">üóëÔ∏è Fjern Udl√∏b</button>
            <button onclick="closeExpireModal()" class="btn btn-secondary">Annuller</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Cache management functions (global scope)
async function refreshCacheInfo() {
    const cacheStatsDiv = document.getElementById('cacheStats');
    cacheStatsDiv.innerHTML = '<p style="text-align: center; color: #718096;">Indl√¶ser...</p>';

    try {
        const response = await fetch('/api/cache-info');
        const data = await response.json();

        const html = `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                    <div style="font-size: 12px; color: #718096; margin-bottom: 5px;">Optimerede Media</div>
                    <div style="font-size: 24px; font-weight: bold; color: #667eea;">${data.optimized_folder.size_mb.toFixed(1)} MB</div>
                    <div style="font-size: 12px; color: #718096; margin-top: 5px;">${data.optimized_folder.count} filer</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #48bb78;">
                    <div style="font-size: 12px; color: #718096; margin-bottom: 5px;">Uploads (logos mv.)</div>
                    <div style="font-size: 24px; font-weight: bold; color: #48bb78;">${data.uploads_folder.size_mb.toFixed(1)} MB</div>
                    <div style="font-size: 12px; color: #718096; margin-top: 5px;">${data.uploads_folder.count} filer</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                    <div style="font-size: 12px; color: #718096; margin-bottom: 5px;">Total Server Storage</div>
                    <div style="font-size: 24px; font-weight: bold; color: #f59e0b;">${data.total_size_mb.toFixed(1)} MB</div>
                    <div style="font-size: 12px; color: #718096; margin-top: 5px;">${data.total_media_db} media i database</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #10b981;">
                    <div style="font-size: 12px; color: #718096; margin-bottom: 5px;">Aktive Media</div>
                    <div style="font-size: 24px; font-weight: bold; color: #10b981;">${data.active_media_db}</div>
                    <div style="font-size: 12px; color: #718096; margin-top: 5px;">filer synlige p√• sk√¶rme</div>
                </div>
            </div>
            <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 8px;">
                <div style="font-size: 14px; font-weight: 600; margin-bottom: 10px;">üì± Browser Cache (per enhed)</div>
                <div style="font-size: 12px; color: #718096;">
                    ‚Ä¢ Max 100 MB eller 100 filer<br>
                    ‚Ä¢ Ryddes automatisk ved overskridelse<br>
                    ‚Ä¢ Gamle/slettede filer fjernes automatisk<br>
                    ‚Ä¢ Service Worker version: v3
                </div>
            </div>
        `;

        cacheStatsDiv.innerHTML = html;
    } catch (error) {
        cacheStatsDiv.innerHTML = `<p style="color: #e53e3e;">Fejl ved indl√¶sning: ${error.message}</p>`;
    }
}

async function clearBrowserCache() {
    if (!confirm('Dette rydder DENNE browsers cache.\n\nBem√¶rk: For at rydde cache p√• sk√¶rme skal du genindl√¶se sk√¶rmene (F5).\n\nFors√¶t?')) {
        return;
    }

    try {
        // Clear Service Worker caches
        const cacheNames = await caches.keys();
        await Promise.all(cacheNames.map(name => caches.delete(name)));

        // Clear localStorage
        localStorage.clear();

        alert('Browser cache ryddet! üßπ\n\nSiden genindl√¶ses nu...');
        window.location.reload();
    } catch (error) {
        alert('Fejl ved rydning af cache: ' + error.message);
    }
}

function switchTab(tabId) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));

    // Show selected tab
    document.getElementById('tab-' + tabId).classList.add('active');
    event.target.classList.add('active');
}

function openCreateScreenModal() {
    document.getElementById('createScreenModal').style.display = 'flex';
}

function closeCreateScreenModal() {
    document.getElementById('createScreenModal').style.display = 'none';
}

function toggleScreenMenu(screenId, event) {
    event.stopPropagation();
    const menu = document.getElementById('screenMenu' + screenId);

    // Close all other menus
    document.querySelectorAll('.screen-menu-dropdown').forEach(m => {
        if (m.id !== 'screenMenu' + screenId) {
            m.classList.remove('visible');
        }
    });

    menu.classList.toggle('visible');
}

function openEditScreenModal(screenId, name, location, description) {
    document.getElementById('editScreenId').value = screenId;
    document.getElementById('editScreenName').value = name;
    document.getElementById('editScreenLocation').value = location;
    document.getElementById('editScreenDescription').value = description;

    const form = document.getElementById('editScreenForm');
    form.action = `/screen/${screenId}/edit`;

    document.getElementById('editScreenModal').style.display = 'flex';

    // Close dropdown
    document.querySelectorAll('.screen-menu-dropdown').forEach(m => m.classList.remove('visible'));
}

function closeEditScreenModal() {
    document.getElementById('editScreenModal').style.display = 'none';
}

function confirmDeleteScreen(screenId, name) {
    if (confirm(`Er du sikker p√• at du vil slette sk√¶rmen "${name}"?\n\nAlle data og indstillinger for denne sk√¶rm vil blive slettet permanent.`)) {
        window.location.href = `/screen/${screenId}/delete`;
    }

    // Close dropdown
    document.querySelectorAll('.screen-menu-dropdown').forEach(m => m.classList.remove('visible'));
}

function toggleScreen(screenId, element) {
    fetch(`/screen/${screenId}/toggle`)
        .then(response => response.json())
        .then(data => {
            element.classList.toggle('active', data.active);
        });
}

function toggleMedia(id, element) {
    fetch(`/toggle/${id}`)
        .then(response => response.json())
        .then(data => {
            element.classList.toggle('active', data.active);
        });
}

function deleteMedia(id) {
    if (confirm('Er du sikker p√• at du vil slette denne fil?')) {
        window.location.href = `/delete/${id}`;
    }
}

function showQRCode(screenId) {
    fetch(`/screen/${screenId}/qr`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('qrImage' + screenId).src = data.qr_code;
            document.getElementById('qrURL' + screenId).textContent = data.url;
            document.getElementById('qrDisplay' + screenId).style.display = 'block';
        });
}

function copyScreenURL(url) {
    navigator.clipboard.writeText(url).then(() => {
        alert('URL kopieret til udklipsholder!');
    });
}

function handleGlobalFileSelect(input) {
    if (input.files.length > 0) {
        document.getElementById('globalUploadForm').submit();
    }
}

function handleScreenFileSelect(input, screenId) {
    if (input.files.length === 0) return;

    const formData = new FormData();
    for (let file of input.files) {
        formData.append('file', file);
    }

    fetch(`/screen/${screenId}/upload`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`${data.count} fil(er) uploadet!`);
            window.location.reload();
        } else {
            alert('Fejl: ' + data.error);
        }
    });
}

// Expire modal functionality
let currentExpireMediaId = null;

function openExpireModal(mediaId, fileName, currentExpire, currentAutoDelete) {
    currentExpireMediaId = mediaId;
    document.getElementById('expireModalFileName').textContent = fileName;

    // Set current values
    if (currentExpire) {
        // Convert ISO string to datetime-local format
        const date = new Date(currentExpire);
        const offset = date.getTimezoneOffset();
        const localDate = new Date(date.getTime() - (offset * 60 * 1000));
        document.getElementById('expireDateTime').value = localDate.toISOString().slice(0, 16);
    } else {
        document.getElementById('expireDateTime').value = '';
    }

    document.getElementById('expireAutoDelete').checked = currentAutoDelete;
    document.getElementById('expireModal').style.display = 'flex';
}

function closeExpireModal() {
    document.getElementById('expireModal').style.display = 'none';
    currentExpireMediaId = null;
}

function saveExpireSettings() {
    if (!currentExpireMediaId) return;

    const expireDateTime = document.getElementById('expireDateTime').value;
    const autoDelete = document.getElementById('expireAutoDelete').checked;

    if (!expireDateTime) {
        alert('V√¶lg venligst en dato og tid');
        return;
    }

    const data = {
        expire_at: new Date(expireDateTime).toISOString(),
        auto_delete: autoDelete
    };

    fetch(`/media/${currentExpireMediaId}/expire`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('Udl√∏bsindstillinger gemt!');
            closeExpireModal();
            window.location.reload();
        } else {
            alert('Fejl: ' + (result.error || 'Kunne ikke gemme'));
        }
    })
    .catch(error => {
        alert('Netv√¶rksfejl: ' + error);
    });
}

function clearExpireSettings() {
    if (!currentExpireMediaId) return;

    if (!confirm('Er du sikker p√• at du vil fjerne udl√∏bsdatoen?')) return;

    fetch(`/media/${currentExpireMediaId}/expire`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({expire_at: null, auto_delete: false})
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('Udl√∏bsdato fjernet!');
            closeExpireModal();
            window.location.reload();
        }
    });
}

function updateScreenMediaDuration(screenId, mediaId, duration) {
    const durationValue = duration === '' ? null : parseInt(duration);

    fetch(`/screen/${screenId}/media/${mediaId}/duration`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({duration: durationValue})
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            console.log(`Duration updated: ${result.duration}ms`);
            // Optional: Show brief success indicator
        } else {
            alert('Fejl: ' + (result.error || 'Kunne ikke opdatere varighed'));
        }
    })
    .catch(error => {
        console.error('Error updating duration:', error);
        alert('Netv√¶rksfejl ved opdatering af varighed');
    });
}

// Bulk selection and delete functions
function updateGlobalBulkActions() {
    const checkboxes = document.querySelectorAll('.global-media-checkbox:checked');
    const bulkActions = document.getElementById('globalBulkActions');
    const countSpan = document.getElementById('globalSelectedCount');

    if (checkboxes.length > 0) {
        bulkActions.classList.add('visible');
        countSpan.textContent = `${checkboxes.length} fil${checkboxes.length > 1 ? 'er' : ''} valgt`;
        checkboxes.forEach(cb => {
            document.getElementById('global-media-' + cb.dataset.mediaId).classList.add('selected');
        });
    } else {
        bulkActions.classList.remove('visible');
    }

    // Remove selected class from unchecked
    document.querySelectorAll('.global-media-checkbox:not(:checked)').forEach(cb => {
        document.getElementById('global-media-' + cb.dataset.mediaId).classList.remove('selected');
    });
}

function updateScreenBulkActions(screenId) {
    const checkboxes = document.querySelectorAll(`.screen-media-checkbox[data-screen-id="${screenId}"]:checked`);
    const bulkActions = document.getElementById('screenBulkActions' + screenId);
    const countSpan = document.getElementById('screenSelectedCount' + screenId);

    if (checkboxes.length > 0) {
        bulkActions.classList.add('visible');
        countSpan.textContent = `${checkboxes.length} fil${checkboxes.length > 1 ? 'er' : ''} valgt`;
        checkboxes.forEach(cb => {
            document.getElementById(`screen-${screenId}-media-${cb.dataset.mediaId}`).classList.add('selected');
        });
    } else {
        bulkActions.classList.remove('visible');
    }

    // Remove selected class from unchecked
    document.querySelectorAll(`.screen-media-checkbox[data-screen-id="${screenId}"]:not(:checked)`).forEach(cb => {
        document.getElementById(`screen-${screenId}-media-${cb.dataset.mediaId}`).classList.remove('selected');
    });
}

function bulkDeleteGlobal() {
    const checkboxes = document.querySelectorAll('.global-media-checkbox:checked');
    const mediaIds = Array.from(checkboxes).map(cb => cb.dataset.mediaId);

    if (mediaIds.length === 0) return;

    if (confirm(`Er du sikker p√• at du vil slette ${mediaIds.length} fil${mediaIds.length > 1 ? 'er' : ''}?`)) {
        Promise.all(mediaIds.map(id =>
            fetch(`/delete/${id}`).then(() => {
                document.getElementById('global-media-' + id).remove();
            })
        )).then(() => {
            window.location.reload();
        });
    }
}

function bulkDeleteScreen(screenId) {
    const checkboxes = document.querySelectorAll(`.screen-media-checkbox[data-screen-id="${screenId}"]:checked`);
    const mediaIds = Array.from(checkboxes).map(cb => cb.dataset.mediaId);

    if (mediaIds.length === 0) return;

    if (confirm(`Er du sikker p√• at du vil slette ${mediaIds.length} fil${mediaIds.length > 1 ? 'er' : ''}?`)) {
        Promise.all(mediaIds.map(id =>
            fetch(`/delete/${id}`).then(() => {
                document.getElementById(`screen-${screenId}-media-${id}`).remove();
            })
        )).then(() => {
            window.location.reload();
        });
    }
}

// Drag and drop support
document.addEventListener('DOMContentLoaded', function() {
    // Close screen menu when clicking outside
    document.addEventListener('click', function() {
        document.querySelectorAll('.screen-menu-dropdown').forEach(m => {
            m.classList.remove('visible');
        });
    });

    document.querySelectorAll('.upload-zone').forEach(zone => {
        zone.addEventListener('dragover', (e) => {
            e.preventDefault();
            zone.classList.add('dragover');
        });

        zone.addEventListener('dragleave', () => {
            zone.classList.remove('dragover');
        });

        zone.addEventListener('drop', (e) => {
            e.preventDefault();
            zone.classList.remove('dragover');

            const screenId = zone.dataset.screenId;
            const input = screenId ?
                document.getElementById('screenFileInput' + screenId) :
                document.getElementById('globalFileInput');

            input.files = e.dataTransfer.files;

            if (screenId) {
                handleScreenFileSelect(input, screenId);
            } else {
                handleGlobalFileSelect(input);
            }
        });
    });

    // Load cache info when system info tab is opened
    document.querySelector('[onclick*="system-info"]')?.addEventListener('click', () => {
        setTimeout(refreshCacheInfo, 100);
    });

    // Run cleanup check every hour
    setInterval(() => {
        fetch('/api/cleanup-expired', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(response => response.json())
        .then(result => {
            if (result.deactivated > 0 || result.deleted > 0) {
                console.log(`Cleanup: ${result.deactivated} deaktiveret, ${result.deleted} slettet`);
                window.location.reload(); // Reload to show changes
            }
        });
    }, 3600000); // Every hour
});
</script>
{% endblock %}
