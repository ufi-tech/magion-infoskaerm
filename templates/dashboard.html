{% extends "base.html" %}

{% block title %}Dashboard - Magion Multi-Screen{% endblock %}

{% block extra_css %}
<style>
    * { box-sizing: border-box; }

    body { background: #f5f7fa; }

    .tabs-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .tab-content {
        display: none;
        padding: 30px;
    }

    .tab-content.active {
        display: block;
    }

    .screen-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e9ecef;
    }

    .screen-info h2 {
        margin: 0 0 10px 0;
        color: #2d3748;
    }

    .screen-meta {
        display: flex;
        gap: 20px;
        color: #718096;
        font-size: 14px;
    }

    .screen-actions {
        display: flex;
        gap: 10px;
    }

    .section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .section h3 {
        margin: 0 0 15px 0;
        color: #2d3748;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .upload-zone {
        border: 2px dashed #cbd5e0;
        border-radius: 8px;
        padding: 30px;
        text-align: center;
        background: white;
        cursor: pointer;
        transition: all 0.2s;
    }

    .upload-zone:hover {
        border-color: #667eea;
        background: #f0f5ff;
    }

    .upload-zone.dragover {
        border-color: #667eea;
        background: #e6f0ff;
    }

    .media-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }

    .media-card {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: move;
        position: relative;
    }

    .media-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .media-card.selected {
        box-shadow: 0 0 0 3px #667eea;
    }

    .media-checkbox {
        position: absolute;
        top: 8px;
        left: 8px;
        width: 22px;
        height: 22px;
        cursor: pointer;
        z-index: 5;
        accent-color: #667eea;
        background: white;
        border: 2px solid #cbd5e0;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .media-checkbox:checked {
        background: #667eea;
        border-color: #667eea;
    }

    .bulk-actions {
        position: sticky;
        top: 0;
        background: #667eea;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        margin-bottom: 15px;
        display: none;
        align-items: center;
        justify-content: space-between;
        z-index: 10;
    }

    .bulk-actions.visible {
        display: flex;
    }

    .media-preview {
        width: 100%;
        height: 120px;
        object-fit: cover;
        background: #e2e8f0;
    }

    .media-info {
        padding: 10px;
    }

    .media-title {
        font-size: 11px;
        color: #2d3748;
        margin-bottom: 8px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .media-controls {
        display: flex;
        gap: 4px;
        margin-top: 8px;
    }

    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
    }

    .btn-primary {
        background: #667eea;
        color: white;
    }

    .btn-primary:hover {
        background: #5568d3;
    }

    .btn-secondary {
        background: #e2e8f0;
        color: #2d3748;
    }

    .btn-secondary:hover {
        background: #cbd5e0;
    }

    .btn-danger {
        background: #fc8181;
        color: white;
    }

    .btn-danger:hover {
        background: #f56565;
    }

    .btn-small {
        padding: 5px 10px;
        font-size: 11px;
    }

    .form-group {
        margin-bottom: 16px;
    }

    .form-group label {
        display: block;
        margin-bottom: 6px;
        color: #4a5568;
        font-size: 14px;
        font-weight: 500;
    }

    .form-group input,
    .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #cbd5e0;
        border-radius: 6px;
        font-size: 14px;
    }

    .form-group input:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .toggle-switch {
        position: relative;
        width: 50px;
        height: 26px;
        background: #cbd5e0;
        border-radius: 13px;
        cursor: pointer;
        transition: background 0.3s;
        display: inline-block;
        vertical-align: middle;
    }

    .toggle-switch.active {
        background: #48bb78;
    }

    .toggle-switch::after {
        content: '';
        position: absolute;
        top: 3px;
        left: 3px;
        width: 20px;
        height: 20px;
        background: white;
        border-radius: 50%;
        transition: transform 0.3s;
    }

    .toggle-switch.active::after {
        transform: translateX(24px);
    }

    .qr-display {
        text-align: center;
        padding: 20px;
        background: white;
        border-radius: 8px;
    }

    .qr-display img {
        max-width: 250px;
        margin: 20px auto;
    }

    .url-display {
        background: #f8f9fa;
        padding: 12px;
        border-radius: 6px;
        font-family: monospace;
        font-size: 12px;
        word-break: break-all;
        margin-top: 10px;
    }

    .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }

    .badge-success {
        background: #c6f6d5;
        color: #22543d;
    }

    .badge-warning {
        background: #feebc8;
        color: #7c2d12;
    }

    .badge-info {
        background: #bee3f8;
        color: #2c5282;
    }

    .display-mode-section {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .display-mode-header {
        background: linear-gradient(135deg, #EF7D00 0%, #D97000 100%);
        color: white;
        padding: 20px 25px;
        border-bottom: 3px solid #C56600;
    }

    .display-mode-header h3 {
        margin: 0 0 8px 0;
        font-size: 18px;
        font-weight: 600;
    }

    .display-mode-header p {
        margin: 0;
        font-size: 13px;
        opacity: 0.9;
    }

    .display-mode-body {
        padding: 25px;
    }

    .mode-selector {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
        margin-bottom: 25px;
    }

    .mode-option {
        position: relative;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        padding: 16px;
        cursor: pointer;
        transition: all 0.2s;
        background: #f8f9fa;
    }

    .mode-option:hover {
        border-color: #EF7D00;
        background: #FFF5EB;
        transform: translateY(-2px);
    }

    .mode-option input[type="radio"] {
        position: absolute;
        opacity: 0;
    }

    .mode-option input[type="radio"]:checked + .mode-content {
        color: #EF7D00;
        font-weight: 600;
    }

    .mode-option input[type="radio"]:checked ~ .mode-indicator {
        background: #EF7D00;
        border-color: #EF7D00;
    }

    .mode-option:has(input:checked) {
        border-color: #EF7D00;
        background: #FFF5EB;
        box-shadow: 0 4px 12px rgba(239, 125, 0, 0.2);
    }

    .mode-content {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 14px;
        color: #4a5568;
        transition: all 0.2s;
    }

    .mode-icon {
        font-size: 20px;
    }

    .mode-indicator {
        position: absolute;
        top: 12px;
        right: 12px;
        width: 18px;
        height: 18px;
        border: 2px solid #cbd5e0;
        border-radius: 50%;
        background: white;
        transition: all 0.2s;
    }

    .mode-indicator::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0);
        width: 8px;
        height: 8px;
        background: white;
        border-radius: 50%;
        transition: transform 0.2s;
    }

    .mode-option:has(input:checked) .mode-indicator::after {
        transform: translate(-50%, -50%) scale(1);
    }

    .settings-card {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-top: 15px;
    }

    .settings-card h4 {
        margin: 0 0 15px 0;
        color: #2d3748;
        font-size: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    /* Statistics Cards */
    .stats-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        transition: all 0.3s;
    }

    .stats-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(239, 125, 0, 0.15);
    }

    .stats-icon {
        font-size: 36px;
        margin-bottom: 12px;
    }

    .stats-value {
        font-size: 32px;
        font-weight: 700;
        color: #EF7D00;
        margin-bottom: 8px;
    }

    .stats-label {
        font-size: 13px;
        color: #718096;
        font-weight: 500;
    }

    /* Screens Grid */
    .screens-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 24px;
    }

    .screen-card {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        transition: all 0.3s;
        cursor: pointer;
        position: relative;
    }

    .screen-card:hover {
        transform: translateY(-6px);
        box-shadow: 0 12px 24px rgba(0,0,0,0.15);
    }

    .screen-card.screen-inactive {
        opacity: 0.7;
    }

    .screen-preview {
        width: 100%;
        height: 180px;
        background: #f8f9fa;
        position: relative;
        overflow: hidden;
    }

    .screen-preview img,
    .screen-preview video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .screen-preview-empty {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }

    .screen-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .inactive-badge {
        background: rgba(255, 255, 255, 0.95);
        color: #e53e3e;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
    }

    .screen-card-content {
        padding: 20px;
    }

    .screen-card-title {
        font-size: 18px;
        font-weight: 600;
        color: #2d3748;
        margin: 0 0 12px 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .screen-card-meta {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-bottom: 16px;
        font-size: 13px;
        color: #718096;
    }

    .screen-card-actions {
        display: flex;
        gap: 8px;
        padding-top: 16px;
        border-top: 1px solid #e9ecef;
    }

    .btn-icon {
        flex: 1;
        padding: 10px;
        background: #f8f9fa;
        border: none;
        border-radius: 8px;
        font-size: 18px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-icon:hover {
        background: #FFF5EB;
        transform: scale(1.1);
    }

    .grid-2col {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    @media (max-width: 968px) {
        .grid-2col {
            grid-template-columns: 1fr;
        }
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #718096;
    }

    .empty-state-icon {
        font-size: 64px;
        margin-bottom: 16px;
        opacity: 0.5;
    }

    .screen-menu {
        position: relative;
        display: inline-block;
    }

    .screen-menu-button {
        background: transparent;
        border: none;
        color: #718096;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 16px;
        transition: all 0.2s;
    }

    .screen-menu-button:hover {
        background: rgba(0,0,0,0.05);
        color: #2d3748;
    }

    .screen-menu-dropdown {
        display: none;
        position: absolute;
        right: 0;
        top: 100%;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        min-width: 200px;
        z-index: 1000;
        margin-top: 4px;
    }

    .screen-menu-dropdown.visible {
        display: block;
    }

    .screen-menu-item {
        padding: 12px 16px;
        cursor: pointer;
        transition: background 0.2s;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .screen-menu-item:last-child {
        border-bottom: none;
    }

    .screen-menu-item:hover {
        background: #f7fafc;
    }

    .screen-menu-item.danger:hover {
        background: #fff5f5;
        color: #c53030;
    }

    /* Screen Tabs */
    .screen-tabs {
        display: flex;
        background: #f8f9fa;
        border-bottom: 2px solid #e2e8f0;
        gap: 5px;
        padding: 10px 10px 0 10px;
    }

    .screen-tab {
        padding: 12px 24px;
        background: transparent;
        border: none;
        color: #718096;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        border-radius: 8px 8px 0 0;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .screen-tab:hover {
        background: rgba(239, 125, 0, 0.1);
        color: #EF7D00;
    }

    .screen-tab.active {
        background: white;
        color: #EF7D00;
        font-weight: 600;
    }

    .screen-tab-content {
        display: none;
        padding: 30px;
        background: white;
    }

    .screen-tab-content.active {
        display: block;
    }

    /* Drag and Drop */
    .media-card.dragging {
        opacity: 0.5;
        transform: rotate(3deg);
    }

    .media-card.drag-over {
        border: 2px dashed #EF7D00;
        background: #FFF5EB;
    }
</style>
{% endblock %}

{% block content %}
<div style="max-width: 1400px; margin: 0 auto;">
    <!-- Content Container -->
    <div class="tabs-container">

        <!-- MAIN DASHBOARD / FORSIDE -->
        <div id="tab-global" class="tab-content active">
            <div style="margin-bottom: 40px;">
                <h1 style="font-size: 32px; color: #2d3748; margin: 0 0 10px 0; font-weight: 700;">Velkommen til Magion üëã</h1>
                <p style="color: #718096; font-size: 16px; margin: 0;">Administrer dine info-sk√¶rme og media her</p>
            </div>

            <!-- Statistics Cards -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px;">
                <div class="stats-card">
                    <div class="stats-icon">üñ•Ô∏è</div>
                    <div class="stats-value">{{ screens|length }}</div>
                    <div class="stats-label">Sk√¶rme Total</div>
                </div>
                <div class="stats-card">
                    <div class="stats-icon">‚úÖ</div>
                    <div class="stats-value">{{ screens|selectattr('active')|list|length }}</div>
                    <div class="stats-label">Aktive Sk√¶rme</div>
                </div>
                <div class="stats-card">
                    <div class="stats-icon">üé¨</div>
                    <div class="stats-value">{{ media_files|length }}</div>
                    <div class="stats-label">Total Media</div>
                </div>
                <div class="stats-card">
                    <div class="stats-icon">üåç</div>
                    <div class="stats-value">{{ media_files|selectattr('is_global')|list|length }}</div>
                    <div class="stats-label">Global Media</div>
                </div>
            </div>

            <!-- Screens Grid -->
            <div style="margin-bottom: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="font-size: 24px; color: #2d3748; margin: 0; font-weight: 600;">Dine Sk√¶rme</h2>
                    <button onclick="openCreateScreenModal()" class="btn btn-primary">‚ûï Opret Ny Sk√¶rm</button>
                </div>

                {% if screens|length > 0 %}
                <div class="screens-grid">
                    {% for screen in screens %}
                    <div class="screen-card {% if not screen.active %}screen-inactive{% endif %}" onclick="switchTab('screen-{{ screen.id }}')">
                        <!-- Preview Image -->
                        <div class="screen-preview">
                            {% if screen.media_associations|length > 0 %}
                                {% set first_media = screen.media_associations[0].media %}
                                {% if first_media.media_type == 'image' %}
                                    <img src="/media/{{ first_media.filename }}" alt="{{ screen.name }}">
                                {% else %}
                                    <video src="/media/{{ first_media.filename }}" muted></video>
                                {% endif %}
                            {% else %}
                                <div class="screen-preview-empty">
                                    <span style="font-size: 48px; opacity: 0.3;">üñ•Ô∏è</span>
                                </div>
                            {% endif %}
                            {% if not screen.active %}
                            <div class="screen-overlay">
                                <span class="inactive-badge">‚è∏Ô∏è Inaktiv</span>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Card Content -->
                        <div class="screen-card-content">
                            <h3 class="screen-card-title">{{ screen.name }}</h3>
                            <div class="screen-card-meta">
                                <span>üìç {{ screen.location or 'Ingen lokation' }}</span>
                                <span>üé¨ {{ screen.media_associations|length }} media</span>
                            </div>
                            <div class="screen-card-actions" onclick="event.stopPropagation()">
                                <button onclick="switchTab('screen-{{ screen.id }}')" class="btn-icon" title="Administrer">‚öôÔ∏è</button>
                                <button onclick="showQRCode({{ screen.id }})" class="btn-icon" title="Vis QR Kode">üì±</button>
                                <button onclick="window.open('{{ url_for('display_screen', screen_uuid=screen.uuid, _external=True) }}', '_blank')" class="btn-icon" title="√Öbn display">üöÄ</button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">üñ•Ô∏è</div>
                    <h3>Ingen sk√¶rme oprettet endnu</h3>
                    <p>Klik p√• "Opret Ny Sk√¶rm" for at komme i gang</p>
                    <button onclick="openCreateScreenModal()" class="btn btn-primary" style="margin-top: 20px;">‚ûï Opret Din F√∏rste Sk√¶rm</button>
                </div>
                {% endif %}
            </div>

            <!-- Global Media Section -->
            <div style="border-top: 2px solid #e2e8f0; padding-top: 30px; margin-top: 40px;">
                <div class="screen-header">
                    <div class="screen-info">
                        <h2 style="font-size: 20px;">üåç Global Media</h2>
                        <p style="color: #718096; margin: 0; font-size: 14px;">Media der vises p√• alle sk√¶rme som ikke har specifikt tildelt media</p>
                    </div>
                </div>

            <div class="section">
                <h3>üì§ Upload Global Media</h3>
                <form method="POST" action="{{ url_for('upload_file') }}" enctype="multipart/form-data" id="globalUploadForm">
                    <div class="upload-zone" onclick="document.getElementById('globalFileInput').click()">
                        <input type="file" id="globalFileInput" name="file" multiple accept="image/*,video/*" style="display: none;" onchange="handleGlobalFileSelect(this)">
                        <div style="font-size: 48px; margin-bottom: 10px;">üìÅ</div>
                        <div style="font-size: 16px; color: #4a5568; margin-bottom: 5px;">Klik for at v√¶lge filer</div>
                        <div style="font-size: 12px; color: #718096;">eller tr√¶k og slip her</div>
                    </div>
                </form>
            </div>

            <div class="section">
                <h3>üé¨ Global Media Liste ({{ media_files|selectattr('is_global')|list|length }} filer)</h3>

                <div class="bulk-actions" id="globalBulkActions">
                    <span id="globalSelectedCount">0 filer valgt</span>
                    <button onclick="bulkDeleteGlobal()" class="btn btn-danger">üóëÔ∏è Slet valgte</button>
                </div>

                <div class="media-grid">
                    {% for media in media_files %}
                    {% if media.is_global %}
                    <div class="media-card" id="global-media-{{ media.id }}">
                        <input type="checkbox" class="media-checkbox global-media-checkbox" data-media-id="{{ media.id }}" onchange="updateGlobalBulkActions()">
                        {% if media.media_type == 'image' %}
                            <img src="/media/{{ media.filename }}" class="media-preview">
                        {% else %}
                            <video src="/media/{{ media.filename }}" class="media-preview"></video>
                        {% endif %}
                        <div class="media-info">
                            <div class="media-title">{{ media.original_filename }}</div>
                            {% if media.expire_at %}
                            <div style="font-size: 10px; color: #ed8936; margin-top: 4px;">
                                ‚è∞ {{ media.expire_at.strftime('%d/%m %H:%M') }}
                                {% if media.auto_delete %}üóëÔ∏è{% endif %}
                            </div>
                            {% endif %}
                            <div class="media-controls">
                                <div class="toggle-switch {% if media.active %}active{% endif %}" onclick="toggleMedia({{ media.id }}, this)"></div>
                                <button onclick="openExpireModal({{ media.id }}, '{{ media.original_filename }}', '{{ media.expire_at.isoformat() if media.expire_at else '' }}', {{ 'true' if media.auto_delete else 'false' }})" class="btn btn-secondary btn-small" title="S√¶t udl√∏bsdato">‚è∞</button>
                                <button onclick="deleteMedia({{ media.id }})" class="btn btn-danger btn-small">Slet</button>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                {% if media_files|selectattr('is_global')|list|length == 0 %}
                <div class="empty-state">
                    <div class="empty-state-icon">üì≠</div>
                    <p>Ingen global media uploadet endnu</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- SCREEN TABS -->
        {% for screen in screens %}
        <div id="tab-screen-{{ screen.id }}" class="tab-content">
            <div class="screen-header">
                <div class="screen-info">
                    <h2>{{ screen.name }}</h2>
                    <div class="screen-meta">
                        <span>üìç {{ screen.location or 'Ingen lokation' }}</span>
                        <span>üîë {{ screen.pairing_code }}</span>
                        <span>
                            {% if screen.active %}
                            <span class="badge badge-success">Aktiv</span>
                            {% else %}
                            <span class="badge badge-warning">Inaktiv</span>
                            {% endif %}
                        </span>
                    </div>
                </div>
                <div class="screen-actions">
                    <button onclick="showQRCode({{ screen.id }})" class="btn btn-secondary">üì± QR Kode</button>
                    <button onclick="copyScreenURL('{{ url_for('display_screen', screen_uuid=screen.uuid, _external=True) }}')" class="btn btn-secondary">üîó Kopi URL</button>
                    <div class="toggle-switch {% if screen.active %}active{% endif %}" onclick="toggleScreen({{ screen.id }}, this)"></div>
                    <div class="screen-menu">
                        <button class="screen-menu-button" onclick="toggleScreenMenu({{ screen.id }}, event)">‚ãÆ</button>
                        <div class="screen-menu-dropdown" id="screenMenu{{ screen.id }}">
                            <div class="screen-menu-item" onclick="openEditScreenModal({{ screen.id }}, '{{ screen.name }}', '{{ screen.location or '' }}', '{{ screen.description or '' }}')">
                                ‚úèÔ∏è Rediger sk√¶rm
                            </div>
                            {% if user.role == 'admin' or user.is_admin %}
                            <div class="screen-menu-item danger" onclick="confirmDeleteScreen({{ screen.id }}, '{{ screen.name }}')">
                                üóëÔ∏è Slet sk√¶rm
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Screen Tabs -->
            <div class="screen-tabs">
                <button class="screen-tab active" onclick="switchScreenTab({{ screen.id }}, 'upload')">
                    üì§ Upload
                </button>
                <button class="screen-tab" onclick="switchScreenTab({{ screen.id }}, 'settings')">
                    ‚öôÔ∏è Indstillinger
                </button>
                <button class="screen-tab" onclick="switchScreenTab({{ screen.id }}, 'media')">
                    üé¨ Media ({{ screen.media_associations|length }})
                </button>
            </div>

            <!-- Tab: Upload -->
            <div id="screen{{ screen.id }}-tab-upload" class="screen-tab-content active">
                <div class="section">
                    <h3>üì§ Upload til {{ screen.name }}</h3>
                    <div class="upload-zone" onclick="document.getElementById('screenFileInput{{ screen.id }}').click()" data-screen-id="{{ screen.id }}">
                        <input type="file" id="screenFileInput{{ screen.id }}" multiple accept="image/*,video/*" style="display: none;" onchange="handleScreenFileSelect(this, {{ screen.id }})">
                        <div style="font-size: 48px; margin-bottom: 10px;">üìÅ</div>
                        <div style="font-size: 16px; color: #4a5568; margin-bottom: 5px;">Upload media kun til denne sk√¶rm</div>
                        <div style="font-size: 12px; color: #718096;">Klik eller tr√¶k filer her</div>
                    </div>
                </div>
            </div>

            <!-- Tab: Settings -->
            <div id="screen{{ screen.id }}-tab-settings" class="screen-tab-content">
                <form method="POST" action="{{ url_for('update_screen_settings', screen_id=screen.id) }}" id="displayModeForm{{ screen.id }}" enctype="multipart/form-data">
                    {% set current_mode = screen.display_mode or 'media' %}
                    {% if screen.redirect_enabled and screen.redirect_url %}
                        {% set current_mode = 'redirect' %}
                    {% endif %}

                    <!-- Display Mode Card -->
                    <div class="display-mode-section">
                        <div class="display-mode-header">
                            <h3>üéØ Display Mode</h3>
                            <p>V√¶lg hvordan denne sk√¶rm skal vise indhold</p>
                        </div>
                        <div class="display-mode-body">
                            <div class="mode-selector">
                                <label class="mode-option">
                                    <input type="radio" name="display_mode" value="media" {% if current_mode == 'media' %}checked{% endif %} onchange="toggleDisplayModeFields{{ screen.id }}()">
                                    <div class="mode-content">
                                        <span class="mode-icon">üì∫</span>
                                        <span>Media Rotation</span>
                                    </div>
                                    <div class="mode-indicator"></div>
                                </label>

                                <label class="mode-option">
                                    <input type="radio" name="display_mode" value="redirect" {% if current_mode == 'redirect' %}checked{% endif %} onchange="toggleDisplayModeFields{{ screen.id }}()">
                                    <div class="mode-content">
                                        <span class="mode-icon">üîó</span>
                                        <span>URL Redirect</span>
                                    </div>
                                    <div class="mode-indicator"></div>
                                </label>

                                <label class="mode-option">
                                    <input type="radio" name="display_mode" value="iframe" {% if current_mode == 'iframe' %}checked{% endif %} onchange="toggleDisplayModeFields{{ screen.id }}()">
                                    <div class="mode-content">
                                        <span class="mode-icon">üñºÔ∏è</span>
                                        <span>iFrame</span>
                                    </div>
                                    <div class="mode-indicator"></div>
                                </label>

                                <label class="mode-option">
                                    <input type="radio" name="display_mode" value="json_api" {% if current_mode == 'json_api' %}checked{% endif %} onchange="toggleDisplayModeFields{{ screen.id }}()">
                                    <div class="mode-content">
                                        <span class="mode-icon">üìä</span>
                                        <span>JSON API</span>
                                    </div>
                                    <div class="mode-indicator"></div>
                                </label>
                            </div>

                            <!-- Redirect URL Settings -->
                            <div class="settings-card mode-field mode-redirect{{ screen.id }}" style="display: none;">
                                <h4>üîó Redirect Indstillinger</h4>
                                <div class="form-group">
                                    <label>URL til redirect</label>
                                    <input type="url" name="redirect_url" value="{{ screen.redirect_url or '' }}" placeholder="https://example.com">
                                    <small style="color: #718096; display: block; margin-top: 5px;">Sk√¶rmen viderestiller automatisk til denne URL</small>
                                </div>
                            </div>

                            <!-- iFrame Settings -->
                            <div class="settings-card mode-field mode-iframe{{ screen.id }}" style="display: none;">
                                <h4>üñºÔ∏è iFrame Indstillinger</h4>
                                <div class="form-group">
                                    <label>URL til iFrame</label>
                                    <input type="url" name="iframe_url" value="{{ screen.iframe_url or '' }}" placeholder="https://example.com">
                                    <small style="color: #718096; display: block; margin-top: 5px;">Vis ekstern hjemmeside i fuld sk√¶rm</small>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                                    <div class="form-group">
                                        <label>‚Üê Venstre Margin (px)</label>
                                        <input type="number" name="iframe_margin_left" value="{{ screen.iframe_margin_left or 0 }}" min="0" max="1000" placeholder="0">
                                        <small style="color: #718096;">Skub indhold fra venstre</small>
                                    </div>
                                    <div class="form-group">
                                        <label>H√∏jre Margin (px) ‚Üí</label>
                                        <input type="number" name="iframe_margin_right" value="{{ screen.iframe_margin_right or 0 }}" min="0" max="1000" placeholder="0">
                                        <small style="color: #718096;">Skub indhold fra h√∏jre</small>
                                    </div>
                                </div>
                            </div>

                            <!-- JSON API Settings -->
                            <div class="settings-card mode-field mode-json_api{{ screen.id }}" style="display: none;">
                                <h4>üìä JSON API Indstillinger</h4>
                                <div class="form-group">
                                    <label>JSON API URL</label>
                                    <input type="url" name="json_api_url" value="{{ screen.json_api_url or '' }}" placeholder="https://api.example.com/data">
                                    <small style="color: #718096; display: block; margin-top: 5px;">URL til JSON data (f.eks. aktivitetsplan)</small>
                                </div>
                                <div class="form-group">
                                    <label>Display Template</label>
                                    <select name="json_template" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #cbd5e0; background: white;">
                                        <option value="schedule" {% if screen.json_template == 'schedule' or not screen.json_template %}selected{% endif %}>üìÖ Kort Visning (cards)</option>
                                        <option value="table" {% if screen.json_template == 'table' %}selected{% endif %}>üìä Tabel - Lille (kompakt)</option>
                                        <option value="table-large" {% if screen.json_template == 'table-large' %}selected{% endif %}>üìä Tabel - Stor (romslig)</option>
                                        <option value="timeline" {% if screen.json_template == 'timeline' %}selected{% endif %}>‚è∞ Tidslinje (visuelt)</option>
                                        <option value="compact" {% if screen.json_template == 'compact' %}selected{% endif %}>üìã Kompakt - Lille</option>
                                        <option value="compact-large" {% if screen.json_template == 'compact-large' %}selected{% endif %}>üìã Kompakt - Stor</option>
                                    </select>
                                    <small style="color: #718096; display: block; margin-top: 5px;">V√¶lg hvordan aktivitetsdata skal vises p√• sk√¶rmen</small>
                                </div>

                                <div class="form-group" style="margin-top: 20px;">
                                    <label>üé® MAGION Logo</label>
                                    {% if screen.magion_logo_path %}
                                    <div style="margin-bottom: 10px;">
                                        <img src="{{ screen.magion_logo_path }}" alt="MAGION logo" style="max-width: 200px; max-height: 60px; background: #EF7D00; padding: 5px; border-radius: 4px;">
                                    </div>
                                    {% endif %}
                                    <input type="file" name="magion_logo" accept="image/*">
                                    <small style="color: #718096; display: block; margin-top: 5px;">Upload MAGION logo (hvid logo anbefalet). Lad tom for at bruge standard logo.</small>
                                </div>

                                <div class="form-group">
                                    <label>üè¢ Hovedsponsor Logo</label>
                                    {% if screen.sponsor_logo_path %}
                                    <div style="margin-bottom: 10px;">
                                        <img src="{{ screen.sponsor_logo_path }}" alt="Sponsor logo" style="max-width: 200px; max-height: 60px; background: white; padding: 5px; border-radius: 4px;">
                                    </div>
                                    {% endif %}
                                    <input type="file" name="sponsor_logo" accept="image/*">
                                    <small style="color: #718096; display: block; margin-top: 5px;">Upload sponsor logo der vises centreret i header (anbefalet: hvid logo p√• transparent baggrund)</small>
                                </div>

                                <div style="border-top: 2px solid #e2e8f0; padding-top: 20px; margin-top: 20px;">
                                    <label style="font-size: 15px; font-weight: 600; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; color: #2d3748;">
                                        <input type="checkbox" name="carousel_enabled" value="true" {% if screen.carousel_enabled %}checked{% endif %} style="width: 20px; height: 20px; cursor: pointer; accent-color: #EF7D00;">
                                        üé† Sponsor Carousel (bund af sk√¶rm)
                                    </label>
                                    <small style="color: #718096; display: block; margin-bottom: 15px;">Aktiver for at vise scrollende sponsor logoer i bunden af sk√¶rmen</small>

                                    <div id="carouselSettings{{ screen.id }}" style="{% if not screen.carousel_enabled %}display: none;{% endif %}">
                                        <div class="form-group">
                                            <label>‚ö° Scroll Hastighed</label>
                                            <select name="carousel_speed">
                                                <option value="slow" {% if screen.carousel_speed == 'slow' %}selected{% endif %}>üêå Langsom (60s)</option>
                                                <option value="medium" {% if screen.carousel_speed == 'medium' or not screen.carousel_speed %}selected{% endif %}>üö∂ Medium (40s)</option>
                                                <option value="fast" {% if screen.carousel_speed == 'fast' %}selected{% endif %}>üèÉ Hurtig (25s)</option>
                                            </select>
                                        </div>

                                        <div class="form-group">
                                            <label>üì§ Sponsor Logoer</label>
                                            <div id="carouselLogos{{ screen.id }}" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px;">
                                                {% for sponsor in screen.carousel_sponsors %}
                                                <div class="carousel-logo-item" style="position: relative; background: white; padding: 5px; border-radius: 4px; border: 1px solid #e2e8f0;">
                                                    <img src="{{ sponsor.filename }}" alt="{{ sponsor.original_filename }}" style="height: 50px; width: auto; max-width: 120px; object-fit: contain;">
                                                    <button type="button" onclick="deleteCarouselSponsor({{ screen.id }}, {{ sponsor.id }})" style="position: absolute; top: -5px; right: -5px; background: #e74c3c; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px; line-height: 1;">√ó</button>
                                                </div>
                                                {% endfor %}
                                            </div>
                                            <input type="file" id="carouselUpload{{ screen.id }}" multiple accept="image/*" style="display: none;" onchange="uploadCarouselSponsors({{ screen.id }})">
                                            <button type="button" onclick="document.getElementById('carouselUpload{{ screen.id }}').click()" class="btn btn-secondary" style="width: 100%;">
                                                ‚ûï Tilf√∏j Sponsor Logoer
                                            </button>
                                            <small style="color: #718096; display: block; margin-top: 5px;">Upload flere sponsor logoer (PNG/JPG med transparent baggrund anbefalet)</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 20px;">üíæ Gem Indstillinger</button>
                        </div>
                    </div>
                </form>

                    <script>
                    function toggleDisplayModeFields{{ screen.id }}() {
                        const form = document.getElementById('displayModeForm{{ screen.id }}');
                        const selectedMode = form.querySelector('input[name="display_mode"]:checked').value;

                        // Hide all mode-specific fields
                        form.querySelectorAll('.mode-field').forEach(field => {
                            field.style.display = 'none';
                        });

                        // Show fields for selected mode
                        form.querySelectorAll('.mode-' + selectedMode + '{{ screen.id }}').forEach(field => {
                            field.style.display = 'block';
                        });
                    }

                    // Initialize on page load
                    toggleDisplayModeFields{{ screen.id }}();

                    // Toggle carousel settings visibility
                    document.querySelector('input[name="carousel_enabled"]').addEventListener('change', function() {
                        const settings = document.getElementById('carouselSettings{{ screen.id }}');
                        settings.style.display = this.checked ? 'block' : 'none';
                    });

                    // Upload carousel sponsors
                    async function uploadCarouselSponsors(screenId) {
                        const fileInput = document.getElementById('carouselUpload' + screenId);
                        const files = fileInput.files;

                        if (files.length === 0) return;

                        const formData = new FormData();
                        for (let i = 0; i < files.length; i++) {
                            formData.append('carousel_sponsors', files[i]);
                        }

                        try {
                            const response = await fetch(`/screen/${screenId}/carousel/upload`, {
                                method: 'POST',
                                body: formData
                            });

                            const result = await response.json();
                            if (result.success) {
                                location.reload(); // Reload to show new logos
                            }
                        } catch (error) {
                            alert('Fejl ved upload: ' + error.message);
                        }
                    }

                    // Delete carousel sponsor
                    async function deleteCarouselSponsor(screenId, sponsorId) {
                        if (!confirm('Slet dette sponsor logo?')) return;

                        try {
                            const response = await fetch(`/screen/${screenId}/carousel/${sponsorId}/delete`, {
                                method: 'POST'
                            });

                            const result = await response.json();
                            if (result.success) {
                                location.reload(); // Reload to update view
                            }
                        } catch (error) {
                            alert('Fejl ved sletning: ' + error.message);
                        }
                    }
                    </script>
                </div>
            </div>

            <!-- Tab: Media -->
            <div id="screen{{ screen.id }}-tab-media" class="screen-tab-content">
                <div class="section">
                    <h3>üé¨ Media p√• {{ screen.name }} ({{ screen.media_associations|length }} filer)</h3>
                    <p style="color: #718096; font-size: 13px; margin-bottom: 15px;">
                        üí° Tip: Tr√¶k og slip billeder for at √¶ndre r√¶kkef√∏lgen
                    </p>

                        <div class="bulk-actions" id="screenBulkActions{{ screen.id }}">
                            <span id="screenSelectedCount{{ screen.id }}">0 filer valgt</span>
                            <button onclick="bulkDeleteScreen({{ screen.id }})" class="btn btn-danger">üóëÔ∏è Slet valgte</button>
                        </div>

                        <div class="media-grid" id="screenMediaGrid{{ screen.id }}">
                            {% for assoc in screen.media_associations %}
                            {% set media = assoc.media %}
                            <div class="media-card" id="screen-{{ screen.id }}-media-{{ media.id }}">
                                <input type="checkbox" class="media-checkbox screen-media-checkbox" data-screen-id="{{ screen.id }}" data-media-id="{{ media.id }}" onchange="updateScreenBulkActions({{ screen.id }})">
                                {% if media.media_type == 'image' %}
                                    <img src="/media/{{ media.filename }}" class="media-preview">
                                {% else %}
                                    <video src="/media/{{ media.filename }}" class="media-preview"></video>
                                {% endif %}
                                <div class="media-info">
                                    <div class="media-title">{{ media.original_filename }}</div>
                                    <div style="font-size: 10px; color: #718096; margin-top: 4px; display: flex; align-items: center; gap: 4px;">
                                        ‚è±Ô∏è Varighed:
                                        <input type="number"
                                               class="duration-input"
                                               value="{{ ((assoc.duration if assoc.duration else media.duration) / 1000)|int }}"
                                               onchange="updateScreenMediaDuration({{ screen.id }}, {{ media.id }}, this.value * 1000)"
                                               style="width: 50px; padding: 2px 4px; border: 1px solid #cbd5e0; border-radius: 3px; font-size: 10px;">
                                        sek
                                        {% if assoc.duration %}
                                        <span style="color: #667eea;" title="Custom duration for this screen">üéØ</span>
                                        {% endif %}
                                    </div>
                                    {% if media.expire_at %}
                                    <div style="font-size: 10px; color: #ed8936; margin-top: 4px;">
                                        ‚è∞ {{ media.expire_at.strftime('%d/%m %H:%M') }}
                                        {% if media.auto_delete %}üóëÔ∏è{% endif %}
                                    </div>
                                    {% endif %}
                                    <div class="media-controls">
                                        <div class="toggle-switch {% if media.active %}active{% endif %}" onclick="toggleMedia({{ media.id }}, this)"></div>
                                        <button onclick="openExpireModal({{ media.id }}, '{{ media.original_filename }}', '{{ media.expire_at.isoformat() if media.expire_at else '' }}', {{ 'true' if media.auto_delete else 'false' }})" class="btn btn-secondary btn-small" title="S√¶t udl√∏bsdato">‚è∞</button>
                                        <button onclick="deleteMedia({{ media.id }})" class="btn btn-danger btn-small">Slet</button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% if screen.media_associations|length == 0 %}
                        <div class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <p>Ingen media uploadet til denne sk√¶rm</p>
                            <p style="font-size: 12px;">Denne sk√¶rm viser global media</p>
                        </div>
                        {% endif %}
                </div>

                <div class="qr-display" id="qrDisplay{{ screen.id }}" style="display: none;">
                    <h3>QR Kode - {{ screen.name }}</h3>
                    <img id="qrImage{{ screen.id }}" src="" alt="QR Code">
                    <div class="url-display" id="qrURL{{ screen.id }}"></div>
                </div>
            </div>
        </div>
        {% endfor %}

        {% if screens|length == 0 %}
        <div class="tab-content active">
            <div class="empty-state">
                <div class="empty-state-icon">üì∫</div>
                <h3>Ingen sk√¶rme oprettet endnu</h3>
                <p>Klik p√• "Opret Ny Sk√¶rm" for at komme i gang</p>
            </div>
        </div>
        {% endif %}

        <!-- SYSTEM INFO TAB -->
        <div id="tab-system-info" class="tab-content">
            <div class="screen-header">
                <div class="screen-info">
                    <h2>üíæ System Information</h2>
                    <p style="color: #718096; margin: 0;">Cache status og system ressourcer</p>
                </div>
            </div>

            <div class="section">
                <h3>üìä Cache Statistik</h3>
                <div id="cacheStats" style="padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <p style="text-align: center; color: #718096;">Indl√¶ser cache information...</p>
                </div>
            </div>

            <div class="section" style="margin-top: 20px;">
                <h3>üßπ Cache Kontrol</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="refreshCacheInfo()" class="btn btn-primary" style="flex: 1; min-width: 200px;">
                        üîÑ Genindl√¶s Information
                    </button>
                    <button onclick="clearBrowserCache()" class="btn btn-warning" style="flex: 1; min-width: 200px;">
                        üóëÔ∏è Ryd Browser Cache (Admin)
                    </button>
                </div>
                <p style="margin-top: 10px; font-size: 12px; color: #718096;">
                    üí° Service Worker cache ryddes automatisk n√•r sk√¶rme loader nye filer.
                    Browser cache limits: 100 MB eller 100 filer per enhed.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- CREATE SCREEN MODAL -->
<div id="createScreenModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%;">
        <h2 style="margin-top: 0;">Opret Ny Sk√¶rm</h2>
        <form method="POST" action="{{ url_for('create_screen') }}">
            <div class="form-group">
                <label>Navn *</label>
                <input type="text" name="name" required placeholder="fx. Reception Sk√¶rm">
            </div>
            <div class="form-group">
                <label>Lokation</label>
                <input type="text" name="location" placeholder="fx. Hovedindgang">
            </div>
            <div class="form-group">
                <label>Beskrivelse</label>
                <textarea name="description" rows="3"></textarea>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn btn-primary" style="flex: 1;">Opret Sk√¶rm</button>
                <button type="button" onclick="closeCreateScreenModal()" class="btn btn-secondary" style="flex: 1;">Annuller</button>
            </div>
        </form>
    </div>
</div>

<!-- EDIT SCREEN MODAL -->
<div id="editScreenModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%;">
        <h2 style="margin-top: 0;">Rediger Sk√¶rm</h2>
        <form id="editScreenForm" method="POST">
            <input type="hidden" id="editScreenId" name="screen_id">
            <div class="form-group">
                <label>Navn *</label>
                <input type="text" id="editScreenName" name="name" required placeholder="fx. Reception Sk√¶rm">
            </div>
            <div class="form-group">
                <label>Lokation</label>
                <input type="text" id="editScreenLocation" name="location" placeholder="fx. Hovedindgang">
            </div>
            <div class="form-group">
                <label>Beskrivelse</label>
                <textarea id="editScreenDescription" name="description" rows="3"></textarea>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn btn-primary" style="flex: 1;">Gem √Ündringer</button>
                <button type="button" onclick="closeEditScreenModal()" class="btn btn-secondary" style="flex: 1;">Annuller</button>
            </div>
        </form>
    </div>
</div>

<!-- EXPIRE MODAL -->
<div id="expireModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%;">
        <h2 style="margin-top: 0;">‚è∞ S√¶t Udl√∏bsdato</h2>
        <p style="color: #718096; margin-bottom: 20px;" id="expireModalFileName"></p>

        <div class="form-group">
            <label>Udl√∏bsdato og tid</label>
            <input type="datetime-local" id="expireDateTime" class="form-control" style="width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px;">
            <small style="color: #718096; display: block; margin-top: 5px;">N√•r denne dato/tid n√•s, vil mediet blive deaktiveret eller slettet</small>
        </div>

        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="expireAutoDelete" style="width: 20px; height: 20px;">
                <span>üóëÔ∏è Auto-slet filen n√•r den udl√∏ber</span>
            </label>
            <small style="color: #718096; display: block; margin-top: 5px;">Hvis ikke markeret, bliver filen kun deaktiveret</small>
        </div>

        <div style="background: #f0f5ff; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea; margin: 15px 0;">
            <strong style="color: #667eea;">üí° Tips:</strong>
            <ul style="margin: 10px 0 0 20px; font-size: 13px; color: #4a5568; line-height: 1.6;">
                <li>Perfekt til kampagner med deadline</li>
                <li>S√¶sonbaseret indhold (jul, p√•ske, osv.)</li>
                <li>Tidsbestemt information</li>
                <li>Cleanup k√∏rer automatisk hver time</li>
            </ul>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button onclick="saveExpireSettings()" class="btn btn-primary" style="flex: 1;">üíæ Gem</button>
            <button onclick="clearExpireSettings()" class="btn btn-secondary">üóëÔ∏è Fjern Udl√∏b</button>
            <button onclick="closeExpireModal()" class="btn btn-secondary">Annuller</button>
        </div>
    </div>
</div>

<!-- GLOBAL QR CODE MODAL -->
<div id="globalQRModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; text-align: center;">
        <h2 style="margin-top: 0;" id="qrModalTitle">QR Kode</h2>
        <img id="globalQRImage" src="" alt="QR Code" style="max-width: 300px; margin: 20px auto; display: block;">
        <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; font-family: monospace; font-size: 12px; word-break: break-all; margin: 20px 0;" id="globalQRURL"></div>
        <button onclick="closeGlobalQRModal()" class="btn btn-secondary" style="width: 100%;">Luk</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Cache management functions (global scope)
async function refreshCacheInfo() {
    const cacheStatsDiv = document.getElementById('cacheStats');
    cacheStatsDiv.innerHTML = '<p style="text-align: center; color: #718096;">Indl√¶ser...</p>';

    try {
        const response = await fetch('/api/cache-info');
        const data = await response.json();

        const html = `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                    <div style="font-size: 12px; color: #718096; margin-bottom: 5px;">Optimerede Media</div>
                    <div style="font-size: 24px; font-weight: bold; color: #667eea;">${data.optimized_folder.size_mb.toFixed(1)} MB</div>
                    <div style="font-size: 12px; color: #718096; margin-top: 5px;">${data.optimized_folder.count} filer</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #48bb78;">
                    <div style="font-size: 12px; color: #718096; margin-bottom: 5px;">Uploads (logos mv.)</div>
                    <div style="font-size: 24px; font-weight: bold; color: #48bb78;">${data.uploads_folder.size_mb.toFixed(1)} MB</div>
                    <div style="font-size: 12px; color: #718096; margin-top: 5px;">${data.uploads_folder.count} filer</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                    <div style="font-size: 12px; color: #718096; margin-bottom: 5px;">Total Server Storage</div>
                    <div style="font-size: 24px; font-weight: bold; color: #f59e0b;">${data.total_size_mb.toFixed(1)} MB</div>
                    <div style="font-size: 12px; color: #718096; margin-top: 5px;">${data.total_media_db} media i database</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #10b981;">
                    <div style="font-size: 12px; color: #718096; margin-bottom: 5px;">Aktive Media</div>
                    <div style="font-size: 24px; font-weight: bold; color: #10b981;">${data.active_media_db}</div>
                    <div style="font-size: 12px; color: #718096; margin-top: 5px;">filer synlige p√• sk√¶rme</div>
                </div>
            </div>
            <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 8px;">
                <div style="font-size: 14px; font-weight: 600; margin-bottom: 10px;">üì± Browser Cache (per enhed)</div>
                <div style="font-size: 12px; color: #718096;">
                    ‚Ä¢ Max 100 MB eller 100 filer<br>
                    ‚Ä¢ Ryddes automatisk ved overskridelse<br>
                    ‚Ä¢ Gamle/slettede filer fjernes automatisk<br>
                    ‚Ä¢ Service Worker version: v3
                </div>
            </div>
        `;

        cacheStatsDiv.innerHTML = html;
    } catch (error) {
        cacheStatsDiv.innerHTML = `<p style="color: #e53e3e;">Fejl ved indl√¶sning: ${error.message}</p>`;
    }
}

async function clearBrowserCache() {
    if (!confirm('Dette rydder DENNE browsers cache.\n\nBem√¶rk: For at rydde cache p√• sk√¶rme skal du genindl√¶se sk√¶rmene (F5).\n\nFors√¶t?')) {
        return;
    }

    try {
        // Clear Service Worker caches
        const cacheNames = await caches.keys();
        await Promise.all(cacheNames.map(name => caches.delete(name)));

        // Clear localStorage
        localStorage.clear();

        alert('Browser cache ryddet! üßπ\n\nSiden genindl√¶ses nu...');
        window.location.reload();
    } catch (error) {
        alert('Fejl ved rydning af cache: ' + error.message);
    }
}

function switchTab(tabId) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));

    // Show selected tab
    document.getElementById('tab-' + tabId).classList.add('active');
    event.target.classList.add('active');
}

// Screen Tab Switching
function switchScreenTab(screenId, tabName) {
    // Hide all tabs for this screen
    document.querySelectorAll(`#tab-screen-${screenId} .screen-tab`).forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll(`#tab-screen-${screenId} .screen-tab-content`).forEach(content => {
        content.classList.remove('active');
    });

    // Show selected tab
    document.querySelector(`#tab-screen-${screenId} .screen-tab[onclick*="${tabName}"]`).classList.add('active');
    document.getElementById(`screen${screenId}-tab-${tabName}`).classList.add('active');
}

// Drag and Drop for Media Reordering
let draggedElement = null;
let draggedScreenId = null;
let draggedMediaId = null;

function initializeDragAndDrop() {
    document.querySelectorAll('.media-grid').forEach(grid => {
        const screenId = grid.id.match(/screenMediaGrid(\d+)/)?.[1];
        if (!screenId) return;

        grid.querySelectorAll('.media-card').forEach(card => {
            card.draggable = true;

            card.addEventListener('dragstart', function(e) {
                draggedElement = this;
                draggedScreenId = screenId;
                draggedMediaId = this.id.match(/media-(\d+)/)?.[1];
                this.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });

            card.addEventListener('dragend', function() {
                this.classList.remove('dragging');
                document.querySelectorAll('.media-card').forEach(c => c.classList.remove('drag-over'));
            });

            card.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                if (this !== draggedElement) {
                    this.classList.add('drag-over');
                }
            });

            card.addEventListener('dragleave', function() {
                this.classList.remove('drag-over');
            });

            card.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('drag-over');

                if (this !== draggedElement && draggedElement) {
                    // Reorder in DOM
                    const allCards = Array.from(grid.querySelectorAll('.media-card'));
                    const draggedIndex = allCards.indexOf(draggedElement);
                    const targetIndex = allCards.indexOf(this);

                    if (draggedIndex < targetIndex) {
                        this.parentNode.insertBefore(draggedElement, this.nextSibling);
                    } else {
                        this.parentNode.insertBefore(draggedElement, this);
                    }

                    // Save new order to backend
                    saveMediaOrder(screenId);
                }
            });
        });
    });
}

async function saveMediaOrder(screenId) {
    const grid = document.getElementById(`screenMediaGrid${screenId}`);
    const mediaCards = grid.querySelectorAll('.media-card');
    const mediaIds = Array.from(mediaCards).map(card => {
        const match = card.id.match(/media-(\d+)/);
        return match ? parseInt(match[1]) : null;
    }).filter(id => id !== null);

    try {
        const response = await fetch(`/screen/${screenId}/reorder-media`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({media_ids: mediaIds})
        });

        const result = await response.json();
        if (result.success) {
            console.log('Media order saved successfully');
        } else {
            alert('Fejl ved gem af r√¶kkef√∏lge: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error saving media order:', error);
        alert('Netv√¶rksfejl ved gem af r√¶kkef√∏lge');
    }
}

function openCreateScreenModal() {
    document.getElementById('createScreenModal').style.display = 'flex';
}

function closeCreateScreenModal() {
    document.getElementById('createScreenModal').style.display = 'none';
}

function toggleScreenMenu(screenId, event) {
    event.stopPropagation();
    const menu = document.getElementById('screenMenu' + screenId);

    // Close all other menus
    document.querySelectorAll('.screen-menu-dropdown').forEach(m => {
        if (m.id !== 'screenMenu' + screenId) {
            m.classList.remove('visible');
        }
    });

    menu.classList.toggle('visible');
}

function openEditScreenModal(screenId, name, location, description) {
    document.getElementById('editScreenId').value = screenId;
    document.getElementById('editScreenName').value = name;
    document.getElementById('editScreenLocation').value = location;
    document.getElementById('editScreenDescription').value = description;

    const form = document.getElementById('editScreenForm');
    form.action = `/screen/${screenId}/edit`;

    document.getElementById('editScreenModal').style.display = 'flex';

    // Close dropdown
    document.querySelectorAll('.screen-menu-dropdown').forEach(m => m.classList.remove('visible'));
}

function closeEditScreenModal() {
    document.getElementById('editScreenModal').style.display = 'none';
}

function confirmDeleteScreen(screenId, name) {
    if (confirm(`Er du sikker p√• at du vil slette sk√¶rmen "${name}"?\n\nAlle data og indstillinger for denne sk√¶rm vil blive slettet permanent.`)) {
        window.location.href = `/screen/${screenId}/delete`;
    }

    // Close dropdown
    document.querySelectorAll('.screen-menu-dropdown').forEach(m => m.classList.remove('visible'));
}

function toggleScreen(screenId, element) {
    fetch(`/screen/${screenId}/toggle`)
        .then(response => response.json())
        .then(data => {
            element.classList.toggle('active', data.active);
        });
}

function toggleMedia(id, element) {
    fetch(`/toggle/${id}`)
        .then(response => response.json())
        .then(data => {
            element.classList.toggle('active', data.active);
        });
}

function deleteMedia(id) {
    if (confirm('Er du sikker p√• at du vil slette denne fil?')) {
        window.location.href = `/delete/${id}`;
    }
}

function showQRCode(screenId) {
    fetch(`/screen/${screenId}/qr`)
        .then(response => response.json())
        .then(data => {
            // Use global modal
            document.getElementById('qrModalTitle').textContent = `QR Kode - ${data.screen_name || 'Sk√¶rm'}`;
            document.getElementById('globalQRImage').src = data.qr_code;
            document.getElementById('globalQRURL').textContent = data.url;
            document.getElementById('globalQRModal').style.display = 'flex';

            // Also update screen-specific displays if they exist
            const screenQRImage = document.getElementById('qrImage' + screenId);
            const screenQRURL = document.getElementById('qrURL' + screenId);
            const screenQRDisplay = document.getElementById('qrDisplay' + screenId);

            if (screenQRImage) screenQRImage.src = data.qr_code;
            if (screenQRURL) screenQRURL.textContent = data.url;
            if (screenQRDisplay) screenQRDisplay.style.display = 'block';
        });
}

function closeGlobalQRModal() {
    document.getElementById('globalQRModal').style.display = 'none';
}

function copyScreenURL(url) {
    navigator.clipboard.writeText(url).then(() => {
        alert('URL kopieret til udklipsholder!');
    });
}

function handleGlobalFileSelect(input) {
    if (input.files.length > 0) {
        document.getElementById('globalUploadForm').submit();
    }
}

function handleScreenFileSelect(input, screenId) {
    if (input.files.length === 0) return;

    const formData = new FormData();
    for (let file of input.files) {
        formData.append('file', file);
    }

    fetch(`/screen/${screenId}/upload`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`${data.count} fil(er) uploadet!`);
            window.location.reload();
        } else {
            alert('Fejl: ' + data.error);
        }
    });
}

// Expire modal functionality
let currentExpireMediaId = null;

function openExpireModal(mediaId, fileName, currentExpire, currentAutoDelete) {
    currentExpireMediaId = mediaId;
    document.getElementById('expireModalFileName').textContent = fileName;

    // Set current values
    if (currentExpire) {
        // Convert ISO string to datetime-local format
        const date = new Date(currentExpire);
        const offset = date.getTimezoneOffset();
        const localDate = new Date(date.getTime() - (offset * 60 * 1000));
        document.getElementById('expireDateTime').value = localDate.toISOString().slice(0, 16);
    } else {
        document.getElementById('expireDateTime').value = '';
    }

    document.getElementById('expireAutoDelete').checked = currentAutoDelete;
    document.getElementById('expireModal').style.display = 'flex';
}

function closeExpireModal() {
    document.getElementById('expireModal').style.display = 'none';
    currentExpireMediaId = null;
}

function saveExpireSettings() {
    if (!currentExpireMediaId) return;

    const expireDateTime = document.getElementById('expireDateTime').value;
    const autoDelete = document.getElementById('expireAutoDelete').checked;

    if (!expireDateTime) {
        alert('V√¶lg venligst en dato og tid');
        return;
    }

    const data = {
        expire_at: new Date(expireDateTime).toISOString(),
        auto_delete: autoDelete
    };

    fetch(`/media/${currentExpireMediaId}/expire`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('Udl√∏bsindstillinger gemt!');
            closeExpireModal();
            window.location.reload();
        } else {
            alert('Fejl: ' + (result.error || 'Kunne ikke gemme'));
        }
    })
    .catch(error => {
        alert('Netv√¶rksfejl: ' + error);
    });
}

function clearExpireSettings() {
    if (!currentExpireMediaId) return;

    if (!confirm('Er du sikker p√• at du vil fjerne udl√∏bsdatoen?')) return;

    fetch(`/media/${currentExpireMediaId}/expire`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({expire_at: null, auto_delete: false})
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('Udl√∏bsdato fjernet!');
            closeExpireModal();
            window.location.reload();
        }
    });
}

function updateScreenMediaDuration(screenId, mediaId, duration) {
    const durationValue = duration === '' ? null : parseInt(duration);

    fetch(`/screen/${screenId}/media/${mediaId}/duration`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({duration: durationValue})
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            console.log(`Duration updated: ${result.duration}ms`);
            // Optional: Show brief success indicator
        } else {
            alert('Fejl: ' + (result.error || 'Kunne ikke opdatere varighed'));
        }
    })
    .catch(error => {
        console.error('Error updating duration:', error);
        alert('Netv√¶rksfejl ved opdatering af varighed');
    });
}

// Bulk selection and delete functions
function updateGlobalBulkActions() {
    const checkboxes = document.querySelectorAll('.global-media-checkbox:checked');
    const bulkActions = document.getElementById('globalBulkActions');
    const countSpan = document.getElementById('globalSelectedCount');

    if (checkboxes.length > 0) {
        bulkActions.classList.add('visible');
        countSpan.textContent = `${checkboxes.length} fil${checkboxes.length > 1 ? 'er' : ''} valgt`;
        checkboxes.forEach(cb => {
            document.getElementById('global-media-' + cb.dataset.mediaId).classList.add('selected');
        });
    } else {
        bulkActions.classList.remove('visible');
    }

    // Remove selected class from unchecked
    document.querySelectorAll('.global-media-checkbox:not(:checked)').forEach(cb => {
        document.getElementById('global-media-' + cb.dataset.mediaId).classList.remove('selected');
    });
}

function updateScreenBulkActions(screenId) {
    const checkboxes = document.querySelectorAll(`.screen-media-checkbox[data-screen-id="${screenId}"]:checked`);
    const bulkActions = document.getElementById('screenBulkActions' + screenId);
    const countSpan = document.getElementById('screenSelectedCount' + screenId);

    if (checkboxes.length > 0) {
        bulkActions.classList.add('visible');
        countSpan.textContent = `${checkboxes.length} fil${checkboxes.length > 1 ? 'er' : ''} valgt`;
        checkboxes.forEach(cb => {
            document.getElementById(`screen-${screenId}-media-${cb.dataset.mediaId}`).classList.add('selected');
        });
    } else {
        bulkActions.classList.remove('visible');
    }

    // Remove selected class from unchecked
    document.querySelectorAll(`.screen-media-checkbox[data-screen-id="${screenId}"]:not(:checked)`).forEach(cb => {
        document.getElementById(`screen-${screenId}-media-${cb.dataset.mediaId}`).classList.remove('selected');
    });
}

function bulkDeleteGlobal() {
    const checkboxes = document.querySelectorAll('.global-media-checkbox:checked');
    const mediaIds = Array.from(checkboxes).map(cb => cb.dataset.mediaId);

    if (mediaIds.length === 0) return;

    if (confirm(`Er du sikker p√• at du vil slette ${mediaIds.length} fil${mediaIds.length > 1 ? 'er' : ''}?`)) {
        Promise.all(mediaIds.map(id =>
            fetch(`/delete/${id}`).then(() => {
                document.getElementById('global-media-' + id).remove();
            })
        )).then(() => {
            window.location.reload();
        });
    }
}

function bulkDeleteScreen(screenId) {
    const checkboxes = document.querySelectorAll(`.screen-media-checkbox[data-screen-id="${screenId}"]:checked`);
    const mediaIds = Array.from(checkboxes).map(cb => cb.dataset.mediaId);

    if (mediaIds.length === 0) return;

    if (confirm(`Er du sikker p√• at du vil slette ${mediaIds.length} fil${mediaIds.length > 1 ? 'er' : ''}?`)) {
        Promise.all(mediaIds.map(id =>
            fetch(`/delete/${id}`).then(() => {
                document.getElementById(`screen-${screenId}-media-${id}`).remove();
            })
        )).then(() => {
            window.location.reload();
        });
    }
}

// Drag and drop support
document.addEventListener('DOMContentLoaded', function() {
    // Close screen menu when clicking outside
    document.addEventListener('click', function() {
        document.querySelectorAll('.screen-menu-dropdown').forEach(m => {
            m.classList.remove('visible');
        });
    });

    document.querySelectorAll('.upload-zone').forEach(zone => {
        zone.addEventListener('dragover', (e) => {
            e.preventDefault();
            zone.classList.add('dragover');
        });

        zone.addEventListener('dragleave', () => {
            zone.classList.remove('dragover');
        });

        zone.addEventListener('drop', (e) => {
            e.preventDefault();
            zone.classList.remove('dragover');

            const screenId = zone.dataset.screenId;
            const input = screenId ?
                document.getElementById('screenFileInput' + screenId) :
                document.getElementById('globalFileInput');

            input.files = e.dataTransfer.files;

            if (screenId) {
                handleScreenFileSelect(input, screenId);
            } else {
                handleGlobalFileSelect(input);
            }
        });
    });

    // Initialize drag and drop for media reordering
    initializeDragAndDrop();

    // Load cache info when system info tab is opened
    document.querySelector('[onclick*="system-info"]')?.addEventListener('click', () => {
        setTimeout(refreshCacheInfo, 100);
    });

    // Run cleanup check every hour
    setInterval(() => {
        fetch('/api/cleanup-expired', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(response => response.json())
        .then(result => {
            if (result.deactivated > 0 || result.deleted > 0) {
                console.log(`Cleanup: ${result.deactivated} deaktiveret, ${result.deleted} slettet`);
                window.location.reload(); // Reload to show changes
            }
        });
    }, 3600000); // Every hour
});
</script>
{% endblock %}
