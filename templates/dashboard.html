{% extends "base.html" %}

{% block title %}Dashboard - Magion Multi-Screen{% endblock %}

{% block extra_css %}
<style>
    * { box-sizing: border-box; }

    body { background: #f5f7fa; }

    .tabs-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin: 20px 0;
        overflow: hidden;
    }

    .tabs-header {
        display: flex;
        background: #f8f9fa;
        border-bottom: 2px solid #e9ecef;
        overflow-x: auto;
        scrollbar-width: thin;
    }

    .tab-button {
        padding: 16px 24px;
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        color: #6c757d;
        border-bottom: 3px solid transparent;
        transition: all 0.2s;
        white-space: nowrap;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .tab-button:hover {
        color: #495057;
        background: rgba(102, 126, 234, 0.05);
    }

    .tab-button.active {
        color: #667eea;
        border-bottom-color: #667eea;
        background: white;
    }

    .tab-content {
        display: none;
        padding: 30px;
    }

    .tab-content.active {
        display: block;
    }

    .screen-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e9ecef;
    }

    .screen-info h2 {
        margin: 0 0 10px 0;
        color: #2d3748;
    }

    .screen-meta {
        display: flex;
        gap: 20px;
        color: #718096;
        font-size: 14px;
    }

    .screen-actions {
        display: flex;
        gap: 10px;
    }

    .section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .section h3 {
        margin: 0 0 15px 0;
        color: #2d3748;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .upload-zone {
        border: 2px dashed #cbd5e0;
        border-radius: 8px;
        padding: 30px;
        text-align: center;
        background: white;
        cursor: pointer;
        transition: all 0.2s;
    }

    .upload-zone:hover {
        border-color: #667eea;
        background: #f0f5ff;
    }

    .upload-zone.dragover {
        border-color: #667eea;
        background: #e6f0ff;
    }

    .media-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }

    .media-card {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: move;
    }

    .media-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .media-preview {
        width: 100%;
        height: 120px;
        object-fit: cover;
        background: #e2e8f0;
    }

    .media-info {
        padding: 10px;
    }

    .media-title {
        font-size: 11px;
        color: #2d3748;
        margin-bottom: 8px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .media-controls {
        display: flex;
        gap: 4px;
        margin-top: 8px;
    }

    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
    }

    .btn-primary {
        background: #667eea;
        color: white;
    }

    .btn-primary:hover {
        background: #5568d3;
    }

    .btn-secondary {
        background: #e2e8f0;
        color: #2d3748;
    }

    .btn-secondary:hover {
        background: #cbd5e0;
    }

    .btn-danger {
        background: #fc8181;
        color: white;
    }

    .btn-danger:hover {
        background: #f56565;
    }

    .btn-small {
        padding: 5px 10px;
        font-size: 11px;
    }

    .form-group {
        margin-bottom: 16px;
    }

    .form-group label {
        display: block;
        margin-bottom: 6px;
        color: #4a5568;
        font-size: 14px;
        font-weight: 500;
    }

    .form-group input,
    .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #cbd5e0;
        border-radius: 6px;
        font-size: 14px;
    }

    .form-group input:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .toggle-switch {
        position: relative;
        width: 50px;
        height: 26px;
        background: #cbd5e0;
        border-radius: 13px;
        cursor: pointer;
        transition: background 0.3s;
        display: inline-block;
        vertical-align: middle;
    }

    .toggle-switch.active {
        background: #48bb78;
    }

    .toggle-switch::after {
        content: '';
        position: absolute;
        top: 3px;
        left: 3px;
        width: 20px;
        height: 20px;
        background: white;
        border-radius: 50%;
        transition: transform 0.3s;
    }

    .toggle-switch.active::after {
        transform: translateX(24px);
    }

    .qr-display {
        text-align: center;
        padding: 20px;
        background: white;
        border-radius: 8px;
    }

    .qr-display img {
        max-width: 250px;
        margin: 20px auto;
    }

    .url-display {
        background: #f8f9fa;
        padding: 12px;
        border-radius: 6px;
        font-family: monospace;
        font-size: 12px;
        word-break: break-all;
        margin-top: 10px;
    }

    .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }

    .badge-success {
        background: #c6f6d5;
        color: #22543d;
    }

    .badge-warning {
        background: #feebc8;
        color: #7c2d12;
    }

    .badge-info {
        background: #bee3f8;
        color: #2c5282;
    }

    .redirect-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
    }

    .redirect-section input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
        margin-right: 10px;
    }

    .redirect-section input[type="url"] {
        background: rgba(255,255,255,0.9);
        border: 1px solid rgba(255,255,255,0.3);
    }

    .grid-2col {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    @media (max-width: 968px) {
        .grid-2col {
            grid-template-columns: 1fr;
        }
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #718096;
    }

    .empty-state-icon {
        font-size: 64px;
        margin-bottom: 16px;
        opacity: 0.5;
    }
</style>
{% endblock %}

{% block content %}
<div style="max-width: 1400px; margin: 0 auto; padding: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1 style="margin: 0;">üì∫ Multi-Screen Dashboard</h1>
        <button onclick="openCreateScreenModal()" class="btn btn-primary">+ Opret Ny Sk√¶rm</button>
    </div>

    <div class="tabs-container">
        <div class="tabs-header">
            <button class="tab-button active" onclick="switchTab('global')">
                üåç Global Media
            </button>
            {% for screen in screens %}
            <button class="tab-button" onclick="switchTab('screen-{{ screen.id }}')">
                üì∫ {{ screen.name }}
                {% if screen.redirect_enabled %}
                <span class="badge badge-warning">Redirect</span>
                {% elif screen.media_items|length > 0 %}
                <span class="badge badge-success">{{ screen.media_items|length }}</span>
                {% else %}
                <span class="badge badge-info">Global</span>
                {% endif %}
            </button>
            {% endfor %}
        </div>

        <!-- GLOBAL MEDIA TAB -->
        <div id="tab-global" class="tab-content active">
            <div class="screen-header">
                <div class="screen-info">
                    <h2>üåç Global Media</h2>
                    <p style="color: #718096; margin: 0;">Media der vises p√• alle sk√¶rme som ikke har specifikt tildelt media</p>
                </div>
            </div>

            <div class="section">
                <h3>üì§ Upload Global Media</h3>
                <form method="POST" action="{{ url_for('upload_file') }}" enctype="multipart/form-data" id="globalUploadForm">
                    <div class="upload-zone" onclick="document.getElementById('globalFileInput').click()">
                        <input type="file" id="globalFileInput" name="file" multiple accept="image/*,video/*" style="display: none;" onchange="handleGlobalFileSelect(this)">
                        <div style="font-size: 48px; margin-bottom: 10px;">üìÅ</div>
                        <div style="font-size: 16px; color: #4a5568; margin-bottom: 5px;">Klik for at v√¶lge filer</div>
                        <div style="font-size: 12px; color: #718096;">eller tr√¶k og slip her</div>
                    </div>
                </form>
            </div>

            <div class="section">
                <h3>üé¨ Global Media Liste ({{ media_files|selectattr('is_global')|list|length }} filer)</h3>
                <div class="media-grid">
                    {% for media in media_files %}
                    {% if media.is_global %}
                    <div class="media-card">
                        {% if media.media_type == 'image' %}
                            <img src="/media/{{ media.filename }}" class="media-preview">
                        {% else %}
                            <video src="/media/{{ media.filename }}" class="media-preview"></video>
                        {% endif %}
                        <div class="media-info">
                            <div class="media-title">{{ media.original_filename }}</div>
                            <div class="media-controls">
                                <div class="toggle-switch {% if media.active %}active{% endif %}" onclick="toggleMedia({{ media.id }}, this)"></div>
                                <button onclick="deleteMedia({{ media.id }})" class="btn btn-danger btn-small">Slet</button>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                {% if media_files|selectattr('is_global')|list|length == 0 %}
                <div class="empty-state">
                    <div class="empty-state-icon">üì≠</div>
                    <p>Ingen global media uploadet endnu</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- SCREEN TABS -->
        {% for screen in screens %}
        <div id="tab-screen-{{ screen.id }}" class="tab-content">
            <div class="screen-header">
                <div class="screen-info">
                    <h2>{{ screen.name }}</h2>
                    <div class="screen-meta">
                        <span>üìç {{ screen.location or 'Ingen lokation' }}</span>
                        <span>üîë {{ screen.pairing_code }}</span>
                        <span>
                            {% if screen.active %}
                            <span class="badge badge-success">Aktiv</span>
                            {% else %}
                            <span class="badge badge-warning">Inaktiv</span>
                            {% endif %}
                        </span>
                    </div>
                </div>
                <div class="screen-actions">
                    <button onclick="showQRCode({{ screen.id }})" class="btn btn-secondary">üì± QR Kode</button>
                    <button onclick="copyScreenURL('{{ url_for('display_screen', screen_uuid=screen.uuid, _external=True) }}')" class="btn btn-secondary">üîó Kopi URL</button>
                    <div class="toggle-switch {% if screen.active %}active{% endif %}" onclick="toggleScreen({{ screen.id }}, this)"></div>
                </div>
            </div>

            <div class="grid-2col">
                <div>
                    <div class="section">
                        <h3>üì§ Upload til {{ screen.name }}</h3>
                        <div class="upload-zone" onclick="document.getElementById('screenFileInput{{ screen.id }}').click()" data-screen-id="{{ screen.id }}">
                            <input type="file" id="screenFileInput{{ screen.id }}" multiple accept="image/*,video/*" style="display: none;" onchange="handleScreenFileSelect(this, {{ screen.id }})">
                            <div style="font-size: 48px; margin-bottom: 10px;">üìÅ</div>
                            <div style="font-size: 16px; color: #4a5568; margin-bottom: 5px;">Upload media kun til denne sk√¶rm</div>
                            <div style="font-size: 12px; color: #718096;">Klik eller tr√¶k filer her</div>
                        </div>
                    </div>

                    <div class="redirect-section">
                        <h3 style="color: white; margin: 0 0 15px 0;">üîó URL Redirect</h3>
                        <form method="POST" action="{{ url_for('update_screen_settings', screen_id=screen.id) }}">
                            <div class="form-group">
                                <label style="display: flex; align-items: center; color: white;">
                                    <input type="checkbox" name="redirect_enabled" {% if screen.redirect_enabled %}checked{% endif %}>
                                    <span>Aktiver Redirect</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label style="color: white;">Destination URL</label>
                                <input type="url" name="redirect_url" value="{{ screen.redirect_url or '' }}" placeholder="https://example.com">
                            </div>
                            <button type="submit" class="btn" style="background: white; color: #667eea; width: 100%;">üíæ Gem Indstillinger</button>
                        </form>
                    </div>
                </div>

                <div>
                    <div class="section">
                        <h3>üé¨ Media p√• {{ screen.name }} ({{ screen.media_items|length }} filer)</h3>
                        <div class="media-grid" id="screenMediaGrid{{ screen.id }}">
                            {% for media in screen.media_items %}
                            <div class="media-card">
                                {% if media.media_type == 'image' %}
                                    <img src="/media/{{ media.filename }}" class="media-preview">
                                {% else %}
                                    <video src="/media/{{ media.filename }}" class="media-preview"></video>
                                {% endif %}
                                <div class="media-info">
                                    <div class="media-title">{{ media.original_filename }}</div>
                                    <div class="media-controls">
                                        <div class="toggle-switch {% if media.active %}active{% endif %}" onclick="toggleMedia({{ media.id }}, this)"></div>
                                        <button onclick="deleteMedia({{ media.id }})" class="btn btn-danger btn-small">Slet</button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% if screen.media_items|length == 0 %}
                        <div class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <p>Ingen media uploadet til denne sk√¶rm</p>
                            <p style="font-size: 12px;">Denne sk√¶rm viser global media</p>
                        </div>
                        {% endif %}
                    </div>

                    <div class="qr-display" id="qrDisplay{{ screen.id }}" style="display: none;">
                        <h3>QR Kode - {{ screen.name }}</h3>
                        <img id="qrImage{{ screen.id }}" src="" alt="QR Code">
                        <div class="url-display" id="qrURL{{ screen.id }}"></div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}

        {% if screens|length == 0 %}
        <div class="tab-content active">
            <div class="empty-state">
                <div class="empty-state-icon">üì∫</div>
                <h3>Ingen sk√¶rme oprettet endnu</h3>
                <p>Klik p√• "Opret Ny Sk√¶rm" for at komme i gang</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- CREATE SCREEN MODAL -->
<div id="createScreenModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%;">
        <h2 style="margin-top: 0;">Opret Ny Sk√¶rm</h2>
        <form method="POST" action="{{ url_for('create_screen') }}">
            <div class="form-group">
                <label>Navn *</label>
                <input type="text" name="name" required placeholder="fx. Reception Sk√¶rm">
            </div>
            <div class="form-group">
                <label>Lokation</label>
                <input type="text" name="location" placeholder="fx. Hovedindgang">
            </div>
            <div class="form-group">
                <label>Beskrivelse</label>
                <textarea name="description" rows="3"></textarea>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn btn-primary" style="flex: 1;">Opret Sk√¶rm</button>
                <button type="button" onclick="closeCreateScreenModal()" class="btn btn-secondary" style="flex: 1;">Annuller</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function switchTab(tabId) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));

    // Show selected tab
    document.getElementById('tab-' + tabId).classList.add('active');
    event.target.classList.add('active');
}

function openCreateScreenModal() {
    document.getElementById('createScreenModal').style.display = 'flex';
}

function closeCreateScreenModal() {
    document.getElementById('createScreenModal').style.display = 'none';
}

function toggleScreen(screenId, element) {
    fetch(`/screen/${screenId}/toggle`)
        .then(response => response.json())
        .then(data => {
            element.classList.toggle('active', data.active);
        });
}

function toggleMedia(id, element) {
    fetch(`/toggle/${id}`)
        .then(response => response.json())
        .then(data => {
            element.classList.toggle('active', data.active);
        });
}

function deleteMedia(id) {
    if (confirm('Er du sikker p√• at du vil slette denne fil?')) {
        window.location.href = `/delete/${id}`;
    }
}

function showQRCode(screenId) {
    fetch(`/screen/${screenId}/qr`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('qrImage' + screenId).src = data.qr_code;
            document.getElementById('qrURL' + screenId).textContent = data.url;
            document.getElementById('qrDisplay' + screenId).style.display = 'block';
        });
}

function copyScreenURL(url) {
    navigator.clipboard.writeText(url).then(() => {
        alert('URL kopieret til udklipsholder!');
    });
}

function handleGlobalFileSelect(input) {
    if (input.files.length > 0) {
        document.getElementById('globalUploadForm').submit();
    }
}

function handleScreenFileSelect(input, screenId) {
    if (input.files.length === 0) return;

    const formData = new FormData();
    for (let file of input.files) {
        formData.append('file', file);
    }

    fetch(`/screen/${screenId}/upload`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`${data.count} fil(er) uploadet!`);
            window.location.reload();
        } else {
            alert('Fejl: ' + data.error);
        }
    });
}

// Drag and drop support
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.upload-zone').forEach(zone => {
        zone.addEventListener('dragover', (e) => {
            e.preventDefault();
            zone.classList.add('dragover');
        });

        zone.addEventListener('dragleave', () => {
            zone.classList.remove('dragover');
        });

        zone.addEventListener('drop', (e) => {
            e.preventDefault();
            zone.classList.remove('dragover');

            const screenId = zone.dataset.screenId;
            const input = screenId ?
                document.getElementById('screenFileInput' + screenId) :
                document.getElementById('globalFileInput');

            input.files = e.dataTransfer.files;

            if (screenId) {
                handleScreenFileSelect(input, screenId);
            } else {
                handleGlobalFileSelect(input);
            }
        });
    });
});
</script>
{% endblock %}
